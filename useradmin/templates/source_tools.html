<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Source Tools - Disaster Clippy</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }

        header {
            background: #16213e;
            padding: 1rem 2rem;
            border-bottom: 1px solid #0f3460;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 1.5rem;
            color: #e94560;
        }

        header p {
            font-size: 0.9rem;
            color: #888;
            margin-top: 0.25rem;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
        }

        .nav-links a {
            color: #4ecca3;
            text-decoration: none;
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .nav-links a:hover {
            background: #0f3460;
        }

        .nav-links a.active {
            background: #0f3460;
            color: #e94560;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .section {
            background: #16213e;
            border: 1px solid #0f3460;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .section h2 {
            font-size: 1.1rem;
            color: #e94560;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #0f3460;
        }

        .section p.description {
            color: #888;
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }

        .source-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: center;
        }

        .source-selector select {
            flex: 1;
            max-width: 300px;
            padding: 0.75rem;
            border: 1px solid #0f3460;
            border-radius: 6px;
            background: #1a1a2e;
            color: #eee;
            font-size: 0.95rem;
        }

        .source-selector select:focus {
            outline: none;
            border-color: #4ecca3;
        }

        .source-info {
            background: #1a1a2e;
            border: 1px solid #0f3460;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .source-info.ready {
            border-color: #4ecca3;
        }

        .source-info.needs-work {
            border-color: #f9a825;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .info-item {
            background: #0f3460;
            padding: 0.75rem;
            border-radius: 6px;
        }

        .info-item label {
            display: block;
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
        }

        .info-item .value {
            font-size: 0.95rem;
            color: #eee;
        }

        .info-item .value.success { color: #4ecca3; }
        .info-item .value.warning { color: #f9a825; }
        .info-item .value.error { color: #e94560; }

        .checklist {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin: 1rem 0;
        }

        .check-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: #0f3460;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .check-item.has { color: #4ecca3; }
        .check-item.missing { color: #e94560; }

        .tool-section {
            background: #1a1a2e;
            border: 1px solid #0f3460;
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .tool-section h3 {
            font-size: 1rem;
            color: #4ecca3;
            margin-bottom: 0.75rem;
        }

        .tool-section p {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 1rem;
        }

        .tool-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 0.5rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #0f3460;
            border-radius: 6px;
            background: #1a1a2e;
            color: #eee;
            font-size: 0.95rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4ecca3;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .btn {
            padding: 0.6rem 1.25rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: background 0.2s;
        }

        .btn-primary {
            background: #e94560;
            color: white;
        }

        .btn-primary:hover {
            background: #ff6b6b;
        }

        .btn-primary:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #0f3460;
            color: #4ecca3;
            border: 1px solid #4ecca3;
        }

        .btn-secondary:hover {
            background: #4ecca3;
            color: #1a1a2e;
        }

        .btn-success {
            background: #4ecca3;
            color: #1a1a2e;
        }

        .btn-success:hover {
            background: #3db892;
        }

        .btn-warning {
            background: #f9a825;
            color: #1a1a2e;
        }

        .btn-warning:hover {
            background: #ffb74d;
        }

        .btn-danger {
            background: #e94560;
            color: white;
        }

        .btn-danger:hover {
            background: #ff6b6b;
        }

        .output-log {
            background: #0a0a14;
            border: 1px solid #0f3460;
            border-radius: 6px;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            color: #4ecca3;
        }

        .output-log .error {
            color: #e94560;
        }

        .output-log .warning {
            color: #f9a825;
        }

        .output-log .info {
            color: #888;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: #4ecca3;
            color: #1a1a2e;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.error {
            background: #e94560;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #888;
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-v1 { background: #f9a825; color: #1a1a2e; }
        .badge-v2 { background: #4ecca3; color: #1a1a2e; }
        .badge-ready { background: #4ecca3; color: #1a1a2e; }
        .badge-incomplete { background: #e94560; color: white; }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            .form-row {
                grid-template-columns: 1fr;
            }
            .info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div>
            <h1>Source Tools</h1>
            <p>Edit, index, and manage local sources</p>
        </div>
        <div class="nav-links">
            <a href="/useradmin/">Settings</a>
            <a href="/useradmin/packs">Source Packs</a>
            <a href="/useradmin/source-tools" class="active">Source Tools</a>
            <a href="/useradmin/cloud-upload">Cloud Upload</a>
            <a href="/">Chat</a>
        </div>
    </header>

    <div class="container">
        <!-- Source Selector -->
        <div class="section">
            <h2>Select Source</h2>
            <p class="description">Choose a source to view details and run tools</p>

            <div class="source-selector">
                <select id="sourceSelect" onchange="loadSourceDetails()">
                    <option value="">-- Select a source --</option>
                </select>
                <button class="btn btn-secondary" onclick="refreshSources()">Refresh</button>
            </div>
        </div>

        <!-- Source Details -->
        <div id="sourceDetails" style="display: none;">
            <div class="section">
                <h2>Source Details</h2>

                <div id="sourceInfo" class="source-info">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <!-- Edit Source Config -->
            <div class="section">
                <h2>Edit Source Configuration</h2>
                <p class="description">Update source metadata</p>

                <div class="tool-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Display Name</label>
                            <input type="text" id="editName" placeholder="Human-readable name">
                        </div>
                        <div class="form-group">
                            <label>License</label>
                            <select id="editLicense">
                                <option value="Unknown">Unknown</option>
                                <option value="CC BY 4.0">CC BY 4.0</option>
                                <option value="CC BY 3.0">CC BY 3.0</option>
                                <option value="CC BY-SA 4.0">CC BY-SA 4.0</option>
                                <option value="CC BY-SA 3.0">CC BY-SA 3.0</option>
                                <option value="CC BY-NC 4.0">CC BY-NC 4.0</option>
                                <option value="CC BY-NC-SA 4.0">CC BY-NC-SA 4.0</option>
                                <option value="CC0">CC0 (Public Domain)</option>
                                <option value="GFDL">GFDL (GNU Free Documentation)</option>
                                <option value="MIT">MIT</option>
                                <option value="GPL">GPL</option>
                                <option value="Apache 2.0">Apache 2.0</option>
                                <option value="Fair Use">Fair Use</option>
                                <option value="Custom">Custom</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editDescription" rows="2" placeholder="Brief description of the source"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Base URL</label>
                        <input type="text" id="editBaseUrl" placeholder="https://example.com">
                        <p style="font-size: 0.8rem; color: #888; margin-top: 0.25rem;">
                            The original website URL for this source
                        </p>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="editLicenseVerified"> License Verified
                        </label>
                        <p style="font-size: 0.8rem; color: #888; margin-top: 0.25rem;">
                            Check this if you have confirmed the license is accurate
                        </p>
                    </div>
                    <div class="tool-actions">
                        <button class="btn btn-primary" onclick="saveSourceConfig()">Save Configuration</button>
                        <button class="btn btn-secondary" onclick="autoDetect()">Auto-Detect</button>
                    </div>
                    <p style="font-size: 0.8rem; color: #888; margin-top: 0.75rem;">
                        Note: Tags are automatically generated during indexing based on content analysis.
                    </p>
                </div>
            </div>

            <!-- Indexing Tools -->
            <div class="section">
                <h2>Indexing Tools</h2>
                <p class="description">Generate metadata and embeddings for offline search</p>

                <div class="tool-section">
                    <h3>Scan Backup</h3>
                    <p>Scan the pages/ folder and create a backup manifest. Required for HTML sources downloaded from R2.</p>
                    <div class="tool-actions">
                        <button class="btn btn-secondary" id="btnScanBackup" onclick="scanBackup()">Scan Backup</button>
                    </div>
                </div>

                <div class="tool-section">
                    <h3>Generate Metadata</h3>
                    <p>Scan backup files and create metadata (document list, titles, etc.)</p>
                    <div class="tool-actions">
                        <button class="btn btn-primary" id="btnGenerateMetadata" onclick="generateMetadata()">Generate Metadata</button>
                    </div>
                </div>

                <div class="tool-section">
                    <h3>Create Embeddings</h3>
                    <p>Generate vector embeddings for semantic search</p>
                    <div style="display: flex; gap: 1rem; align-items: flex-end; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0; flex: 0 0 150px;">
                            <label>Document Limit</label>
                            <input type="number" id="indexLimit" value="1000" min="1" max="50000" placeholder="1000">
                        </div>
                        <p style="font-size: 0.8rem; color: #888; margin: 0;">
                            Limits how many documents to index. Higher values cost more but cover more content.
                        </p>
                    </div>
                    <div class="tool-actions">
                        <button class="btn btn-primary" id="btnCreateIndex" onclick="createIndex()">Create Index</button>
                        <button class="btn btn-secondary" onclick="createIndex(true)">Force Re-index</button>
                    </div>
                </div>

                <div class="tool-section">
                    <h3>Validate Source</h3>
                    <p>Check if source meets all requirements for distribution</p>
                    <div class="tool-actions">
                        <button class="btn btn-secondary" onclick="validateSource()">Validate</button>
                    </div>
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="section" style="border-color: #e94560;">
                <h2 style="color: #e94560;">Danger Zone</h2>
                <p class="description">Destructive actions - cannot be undone</p>

                <div class="tool-section" style="border-color: #e94560;">
                    <h3 style="color: #e94560;">Delete Source</h3>
                    <p>Completely remove this source from the system. This will delete:</p>
                    <ul style="color: #888; font-size: 0.85rem; margin-left: 1.5rem; margin-bottom: 1rem;">
                        <li>All local backup files (the source folder)</li>
                        <li>Entry from _master.json</li>
                        <li>All ChromaDB vector embeddings</li>
                    </ul>
                    <div class="tool-actions">
                        <button class="btn btn-danger" onclick="deleteSource()">Delete Source</button>
                    </div>
                </div>
            </div>

            <!-- Output Log -->
            <div class="section">
                <h2>Output Log</h2>
                <div id="outputLog" class="output-log">
Ready. Select a source and run a tool to see output here.
                </div>
            </div>
        </div>

        <!-- No Source Selected -->
        <div id="noSourceSelected" class="section">
            <div class="empty-state">
                <p>Select a source from the dropdown above to view details and access tools.</p>
                <p style="margin-top: 1rem; font-size: 0.85rem; color: #666;">
                    Sources are discovered from your configured backup folder
                </p>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let sources = [];
        let currentSource = null;

        // Load sources list
        async function loadSources() {
            try {
                const response = await fetch('/useradmin/api/local-sources');
                const data = await response.json();
                sources = data.sources || [];
                renderSourceSelect();
            } catch (e) {
                console.error('Failed to load sources:', e);
                showToast('Failed to load sources: ' + e.message, true);
            }
        }

        function renderSourceSelect() {
            const select = document.getElementById('sourceSelect');
            const currentValue = select.value;

            select.innerHTML = '<option value="">-- Select a source --</option>';
            sources.forEach(s => {
                const status = s.production_ready ? '[Ready]' : s.is_complete ? '[Complete]' : '[Incomplete]';
                select.innerHTML += `<option value="${s.source_id}">${s.name} ${status}</option>`;
            });

            if (currentValue) {
                select.value = currentValue;
            }
        }

        function refreshSources() {
            showToast('Refreshing sources...');
            loadSources().then(() => {
                if (currentSource) {
                    loadSourceDetails();
                }
                showToast('Sources refreshed');
            });
        }

        // Load details for selected source
        async function loadSourceDetails() {
            const sourceId = document.getElementById('sourceSelect').value;

            if (!sourceId) {
                document.getElementById('sourceDetails').style.display = 'none';
                document.getElementById('noSourceSelected').style.display = 'block';
                currentSource = null;
                return;
            }

            document.getElementById('sourceDetails').style.display = 'block';
            document.getElementById('noSourceSelected').style.display = 'none';

            currentSource = sources.find(s => s.source_id === sourceId);

            if (!currentSource) {
                showToast('Source not found', true);
                return;
            }

            renderSourceInfo();
            populateEditForm();
        }

        function renderSourceInfo() {
            const s = currentSource;
            const container = document.getElementById('sourceInfo');

            const statusClass = s.production_ready ? 'ready' : 'needs-work';
            container.className = `source-info ${statusClass}`;

            const readyLabel = s.production_ready
                ? '<span class="status-badge badge-ready">Ready for Upload</span>'
                : '<span class="status-badge badge-incomplete">Needs Work</span>';

            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="color: #e94560; margin: 0;">${escapeHtml(s.name)}</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        ${readyLabel}
                    </div>
                </div>

                <div class="info-grid">
                    <div class="info-item">
                        <label>Source ID</label>
                        <div class="value">${s.source_id}</div>
                    </div>
                    <div class="info-item">
                        <label>Backup Type</label>
                        <div class="value">${s.backup_type || 'None'}</div>
                    </div>
                    <div class="info-item">
                        <label>Documents</label>
                        <div class="value">${s.document_count || 0}</div>
                    </div>
                    <div class="info-item">
                        <label>Backup Size</label>
                        <div class="value">${s.backup_size_mb || 0} MB</div>
                    </div>
                    <div class="info-item">
                        <label>License</label>
                        <div class="value ${s.license_verified ? 'success' : 'warning'}">${s.license || 'Unknown'}</div>
                    </div>
                    <div class="info-item">
                        <label>URL</label>
                        <div class="value">${s.base_url ? '<a href="' + escapeHtml(s.base_url) + '" target="_blank" style="color: #4ecca3;">' + escapeHtml(s.base_url) + '</a>' : 'Not set'}</div>
                    </div>
                </div>

                <div class="checklist">
                    <span class="check-item ${s.has_config ? 'has' : 'missing'}">${s.has_config ? '[x]' : '[ ]'} Config</span>
                    <span class="check-item ${s.has_backup ? 'has' : 'missing'}">${s.has_backup ? '[x]' : '[ ]'} Backup Files</span>
                    <span class="check-item ${s.has_metadata ? 'has' : 'missing'}">${s.has_metadata ? '[x]' : '[ ]'} Metadata</span>
                    <span class="check-item ${s.has_embeddings ? 'has' : 'missing'}">${s.has_embeddings ? '[x]' : '[ ]'} Embeddings</span>
                    <span class="check-item ${s.license && s.license !== 'Unknown' ? 'has' : 'missing'}">${s.license && s.license !== 'Unknown' ? '[x]' : '[ ]'} License Set</span>
                    <span class="check-item ${s.license_verified ? 'has' : 'missing'}">${s.license_verified ? '[x]' : '[ ]'} License Verified</span>
                </div>

                ${s.missing && s.missing.length > 0 ? `
                <div style="margin-top: 1rem; padding: 0.75rem; background: #2e1a1a; border-radius: 6px;">
                    <span style="color: #e94560; font-weight: 500;">Missing:</span>
                    <span style="color: #f9a825;">${s.missing.join(', ')}</span>
                </div>
                ` : ''}
            `;
        }

        function populateEditForm() {
            const s = currentSource;
            document.getElementById('editName').value = s.name || '';
            document.getElementById('editDescription').value = s.description || '';
            document.getElementById('editLicense').value = s.license || 'Unknown';
            document.getElementById('editBaseUrl').value = s.base_url || '';
            document.getElementById('editLicenseVerified').checked = s.license_verified || false;
        }

        // Save source configuration
        async function saveSourceConfig() {
            if (!currentSource) return;

            const updates = {
                source_id: currentSource.source_id,
                name: document.getElementById('editName').value,
                description: document.getElementById('editDescription').value,
                license: document.getElementById('editLicense').value,
                base_url: document.getElementById('editBaseUrl').value,
                license_verified: document.getElementById('editLicenseVerified').checked
            };

            logOutput(`Saving configuration for ${currentSource.source_id}...`);

            try {
                const response = await fetch('/useradmin/api/update-source-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });

                const data = await response.json();

                if (response.ok) {
                    logOutput(`Configuration saved successfully`, 'success');
                    showToast('Configuration saved');
                    refreshSources();
                } else {
                    logOutput(`Error: ${data.detail || 'Failed to save'}`, 'error');
                    showToast(data.detail || 'Failed to save', true);
                }
            } catch (e) {
                logOutput(`Error: ${e.message}`, 'error');
                showToast('Error: ' + e.message, true);
            }
        }

        // Auto-detect license, description, and URL
        async function autoDetect() {
            if (!currentSource) return;

            logOutput(`Auto-detecting metadata for ${currentSource.source_id}...`);

            try {
                const response = await fetch(`/useradmin/api/auto-detect/${currentSource.source_id}`);
                const data = await response.json();

                let detected = false;

                if (data.license) {
                    document.getElementById('editLicense').value = data.license;
                    logOutput(`Detected license: ${data.license}`, 'success');
                    detected = true;
                }

                if (data.description) {
                    document.getElementById('editDescription').value = data.description;
                    logOutput(`Detected description: ${data.description.substring(0, 100)}...`, 'success');
                    detected = true;
                }

                if (data.base_url) {
                    document.getElementById('editBaseUrl').value = data.base_url;
                    logOutput(`Detected URL: ${data.base_url}`, 'success');
                    detected = true;
                }

                // Tags are logged but not editable here - they come from indexing
                if (data.tags && data.tags.length > 0) {
                    logOutput(`Suggested tags (from content): ${data.tags.join(', ')}`, 'info');
                }

                if (detected) {
                    showToast('Auto-detection complete - review and save');
                } else {
                    logOutput('Could not auto-detect metadata from content', 'warning');
                    showToast('Could not auto-detect', true);
                }
            } catch (e) {
                logOutput(`Error: ${e.message}`, 'error');
                showToast('Error: ' + e.message, true);
            }
        }

        // Scan backup to create manifest
        async function scanBackup() {
            if (!currentSource) return;

            logOutput(`Scanning backup for ${currentSource.source_id}...`);
            document.getElementById('btnScanBackup').disabled = true;

            try {
                const response = await fetch('/useradmin/api/scan-backup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source_id: currentSource.source_id })
                });

                const data = await response.json();

                if (response.ok) {
                    logOutput(`Backup scanned successfully`, 'success');
                    logOutput(`  Pages found: ${data.page_count}`, 'info');
                    logOutput(`  Total size: ${data.total_size_mb} MB`, 'info');
                    logOutput(`  Manifest created: ${data.manifest_path}`, 'info');
                    showToast(`Scanned ${data.page_count} pages`);
                    refreshSources();
                } else {
                    logOutput(`Error: ${data.detail || 'Scan failed'}`, 'error');
                    showToast(data.detail || 'Scan failed', true);
                }
            } catch (e) {
                logOutput(`Error: ${e.message}`, 'error');
                showToast('Error: ' + e.message, true);
            } finally {
                document.getElementById('btnScanBackup').disabled = false;
            }
        }

        // Generate metadata
        async function generateMetadata() {
            if (!currentSource) return;

            logOutput(`Generating metadata for ${currentSource.source_id}...`);
            document.getElementById('btnGenerateMetadata').disabled = true;

            try {
                const response = await fetch('/useradmin/api/generate-metadata', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source_id: currentSource.source_id })
                });

                const data = await response.json();

                if (response.ok) {
                    logOutput(`Metadata generated successfully`, 'success');
                    logOutput(`  Documents: ${data.document_count}`, 'info');
                    logOutput(`  Total chars: ${data.total_chars}`, 'info');
                    logOutput(`  Source type: ${data.source_type}`, 'info');
                    showToast(`Generated metadata: ${data.document_count} documents`);
                    refreshSources();
                } else {
                    logOutput(`Error: ${data.detail || 'Failed to generate metadata'}`, 'error');
                    showToast(data.detail || 'Failed', true);
                }
            } catch (e) {
                logOutput(`Error: ${e.message}`, 'error');
                showToast('Error: ' + e.message, true);
            } finally {
                document.getElementById('btnGenerateMetadata').disabled = false;
            }
        }

        // Create index
        async function createIndex(force = false) {
            if (!currentSource) return;

            // Check if a job is already running for this source
            if (window.jobMonitor && window.jobMonitor.hasActiveJob(currentSource.source_id)) {
                showToast('A job is already running for this source', true);
                return;
            }

            const limit = parseInt(document.getElementById('indexLimit').value) || 1000;
            logOutput(`Starting index job for ${currentSource.source_id}${force ? ' (force re-index)' : ''} with limit ${limit}...`);
            document.getElementById('btnCreateIndex').disabled = true;

            try {
                const response = await fetch('/useradmin/api/create-index', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source_id: currentSource.source_id,
                        force: force,
                        limit: limit
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.status === 'submitted') {
                        // Job submitted - it will run in background
                        logOutput(`Index job submitted (ID: ${data.job_id})`, 'success');
                        logOutput(`  Check the job monitor for progress`, 'info');
                        showToast(`Index job started - running in background`);

                        // Trigger job monitor refresh
                        if (window.jobMonitor) {
                            window.jobMonitor.refresh();
                        }
                    } else {
                        // Synchronous completion (shouldn't happen now, but handle it)
                        logOutput(`Index created successfully`, 'success');
                        logOutput(`  Documents indexed: ${data.indexed_count || 'N/A'}`, 'info');
                        showToast(`Index created: ${data.indexed_count || 0} documents`);
                        refreshSources();
                    }
                } else if (response.status === 409) {
                    // Conflict - job already running
                    logOutput(`Error: ${data.detail || 'A job is already running for this source'}`, 'warning');
                    showToast(data.detail || 'Job already running', true);
                } else {
                    logOutput(`Error: ${data.detail || 'Failed to create index'}`, 'error');
                    showToast(data.detail || 'Failed', true);
                }
            } catch (e) {
                logOutput(`Error: ${e.message}`, 'error');
                showToast('Error: ' + e.message, true);
            } finally {
                document.getElementById('btnCreateIndex').disabled = false;
            }
        }

        // Validate source
        async function validateSource() {
            if (!currentSource) return;

            logOutput(`Validating ${currentSource.source_id}...`);

            try {
                const response = await fetch('/useradmin/api/validate-source', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source_id: currentSource.source_id
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    const result = data.validation;

                    logOutput(`Validation complete`, result.is_valid ? 'success' : 'warning');
                    logOutput(`  Valid: ${result.is_valid}`, result.is_valid ? 'success' : 'error');
                    logOutput(`  Production Ready: ${result.production_ready}`, result.production_ready ? 'success' : 'warning');

                    if (result.issues && result.issues.length > 0) {
                        logOutput(`Issues:`, 'error');
                        result.issues.forEach(i => logOutput(`  - ${i}`, 'error'));
                    }

                    if (result.warnings && result.warnings.length > 0) {
                        logOutput(`Warnings:`, 'warning');
                        result.warnings.forEach(w => logOutput(`  - ${w}`, 'warning'));
                    }

                    if (result.suggested_tags && result.suggested_tags.length > 0) {
                        logOutput(`Suggested tags: ${result.suggested_tags.join(', ')}`, 'info');
                    }

                    // Check for unexpected files that can be cleaned up
                    if (result.redundant_files && result.redundant_files.length > 0) {
                        logOutput(`Unexpected files found (not in v2 schema):`, 'warning');
                        result.redundant_files.forEach(f => logOutput(`  - ${f}`, 'warning'));
                        logOutput(`Expected v2 schema files: _source.json, _documents.json, _embeddings.json, _manifest.json, plus backup files`, 'info');

                        // Offer cleanup option
                        if (confirm(`Found ${result.redundant_files.length} unexpected file(s):\n\n${result.redundant_files.join('\n')}\n\nThese files are not part of the v2 schema and can be safely deleted.\n\nWould you like to delete them now?`)) {
                            await cleanupRedundantFiles();
                        }
                    }

                    showToast(result.is_valid ? 'Validation passed' : 'Validation has issues');
                } else {
                    logOutput(`Error: ${data.detail || 'Validation failed'}`, 'error');
                    showToast(data.detail || 'Failed', true);
                }
            } catch (e) {
                logOutput(`Error: ${e.message}`, 'error');
                showToast('Error: ' + e.message, true);
            }
        }

        // Cleanup redundant files
        async function cleanupRedundantFiles() {
            if (!currentSource) return;

            logOutput(`Cleaning up redundant files for ${currentSource.source_id}...`);

            try {
                const response = await fetch('/useradmin/api/cleanup-redundant-files', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source_id: currentSource.source_id
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.deleted && data.deleted.length > 0) {
                        logOutput(`Cleanup complete:`, 'success');
                        data.deleted.forEach(d => logOutput(`  Deleted: ${d.file} (${d.size_mb} MB)`, 'success'));
                        logOutput(`Total freed: ${data.freed_mb} MB`, 'success');
                    } else {
                        logOutput(`No files to clean up`, 'info');
                    }

                    if (data.kept && data.kept.length > 0) {
                        logOutput(`Kept ${data.kept.length} file(s): ${data.kept.join(', ')}`, 'info');
                    }

                    if (data.errors && data.errors.length > 0) {
                        data.errors.forEach(e => logOutput(`Error: ${e}`, 'error'));
                    }

                    showToast(data.message || `Cleaned up ${data.deleted?.length || 0} file(s)`);

                    // Refresh source details
                    loadSourceDetails();
                } else {
                    logOutput(`Error: ${data.detail || 'Cleanup failed'}`, 'error');
                    showToast(data.detail || 'Cleanup failed', true);
                }
            } catch (e) {
                logOutput(`Error: ${e.message}`, 'error');
                showToast('Error: ' + e.message, true);
            }
        }

        // Delete source
        async function deleteSource() {
            if (!currentSource) return;

            const sourceName = currentSource.name || currentSource.source_id;
            const confirmMsg = `Are you sure you want to delete "${sourceName}"?\n\nThis will remove:\n- All local backup files (the source folder)\n- Entry from _master.json\n- All ChromaDB embeddings\n\nThis action cannot be undone!`;

            if (!confirm(confirmMsg)) {
                logOutput('Delete cancelled by user', 'info');
                return;
            }

            // Double confirmation for safety
            const doubleConfirm = prompt(`Type "${currentSource.source_id}" to confirm deletion:`);
            if (doubleConfirm !== currentSource.source_id) {
                logOutput('Delete cancelled - source ID did not match', 'warning');
                showToast('Delete cancelled', true);
                return;
            }

            logOutput(`Deleting source: ${currentSource.source_id}...`);

            try {
                const response = await fetch('/useradmin/api/delete-source', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source_id: currentSource.source_id,
                        delete_files: true
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    logOutput(`Source deleted successfully`, 'success');
                    if (data.deleted && data.deleted.length > 0) {
                        data.deleted.forEach(d => logOutput(`  Removed: ${d}`, 'success'));
                    }
                    if (data.freed_mb > 0) {
                        logOutput(`  Freed: ${data.freed_mb} MB`, 'success');
                    }
                    if (data.errors && data.errors.length > 0) {
                        data.errors.forEach(e => logOutput(`  Warning: ${e}`, 'warning'));
                    }
                    showToast(data.message || 'Source deleted');

                    // Clear selection and refresh
                    document.getElementById('sourceSelect').value = '';
                    currentSource = null;
                    document.getElementById('sourceDetails').style.display = 'none';
                    document.getElementById('noSourceSelected').style.display = 'block';
                    await loadSources();
                } else {
                    logOutput(`Error: ${data.detail || 'Delete failed'}`, 'error');
                    showToast(data.detail || 'Delete failed', true);
                }
            } catch (e) {
                logOutput(`Error: ${e.message}`, 'error');
                showToast('Error: ' + e.message, true);
            }
        }

        // Output log
        function logOutput(message, type = '') {
            const log = document.getElementById('outputLog');
            const timestamp = new Date().toLocaleTimeString();
            const className = type ? ` class="${type}"` : '';
            log.innerHTML += `<span${className}>[${timestamp}] ${escapeHtml(message)}</span>\n`;
            log.scrollTop = log.scrollHeight;
        }

        function clearLog() {
            document.getElementById('outputLog').innerHTML = '';
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast' + (isError ? ' error' : '');
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize - check for source parameter in URL
        async function init() {
            await loadSources();

            // Check for ?source= parameter
            const urlParams = new URLSearchParams(window.location.search);
            const sourceParam = urlParams.get('source');

            if (sourceParam) {
                const select = document.getElementById('sourceSelect');
                // Wait for sources to load and try to select the source
                if (sources.find(s => s.source_id === sourceParam)) {
                    select.value = sourceParam;
                    loadSourceDetails();
                }
            }
        }

        init();

        // Listen for job completions to refresh the UI
        window.addEventListener('jobComplete', (event) => {
            const job = event.detail;
            if (currentSource && job.source_id === currentSource.source_id) {
                logOutput(`Job completed: ${job.job_type} - ${job.message}`, job.status === 'completed' ? 'success' : 'error');
                loadSourceDetails();  // Refresh source details
            }
        });
    </script>

    <!-- Job Monitor - shows active background jobs -->
    <script src="/useradmin/static/job-monitor.js"></script>
</body>
</html>
