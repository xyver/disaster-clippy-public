<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sources - Disaster Clippy Admin</title>
    <link rel="icon" type="image/png" href="/static/paperclip.png">
    <link rel="stylesheet" href="/admin/static/{{ admin_css }}">
    <style>
        /* Page-specific styles */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid #0f3460;
            padding-bottom: 0.5rem;
        }
        .tab {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
            font-size: 0.9rem;
        }
        .tab:hover { color: #4ecca3; }
        .tab.active { background: #0f3460; color: #e94560; }
        .sub-nav {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .sub-nav a {
            color: #4ecca3;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border: 1px solid #0f3460;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        .sub-nav a:hover { background: #0f3460; }
        .sub-nav a.active { background: #0f3460; color: #e94560; }
        .source-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        .source-card {
            background: #1a1a2e;
            border: 1px solid #0f3460;
            border-radius: 8px;
            padding: 1rem;
        }
        .source-card h3 { color: #4ecca3; font-size: 1rem; margin-bottom: 0.5rem; }
        .source-card .meta { font-size: 0.8rem; color: #888; }
        .status-boxes {
            display: flex;
            gap: 0.25rem;
            margin-top: 0.75rem;
            flex-wrap: wrap;
        }
        .status-box {
            font-size: 0.65rem;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            text-transform: uppercase;
            font-weight: 500;
        }
        .status-box.ok { background: #4ecca320; color: #4ecca3; }
        .status-box.missing { background: #e9456020; color: #e94560; }
        .status-box.warning { background: #f9a82520; color: #f9a825; }
        .source-card .actions {
            margin-top: 0.75rem;
            display: flex;
            gap: 0.5rem;
        }
        .source-card .btn-small {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .source-card .btn-install { background: #4ecca3; color: #1a1a2e; }
        .source-card .btn-edit { background: #0f3460; color: #4ecca3; }
        .source-card .btn-edit:hover { background: #1a1a3e; }
        .placeholder {
            text-align: center;
            padding: 3rem;
            color: #666;
            font-style: italic;
        }
        .loading { text-align: center; padding: 2rem; color: #888; }

        /* Sync mode modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.show { display: flex; }
        .modal-content {
            background: #1a1a2e;
            border: 1px solid #4ecca3;
            border-radius: 8px;
            padding: 1.5rem;
            max-width: 500px;
            width: 90%;
        }
        .modal-title {
            color: #f9a825;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .modal-body { color: #ccc; font-size: 0.9rem; margin-bottom: 1.5rem; }
        .modal-body strong { color: #4ecca3; }
        .modal-body .count { color: #e94560; font-weight: 600; }
        .modal-actions { display: flex; gap: 0.75rem; justify-content: flex-end; }
        .btn-update { background: #0f3460; border: 1px solid #4ecca3; }
        .btn-update:hover { background: #1a4a7a; }
        .btn-replace { background: #5c2030; border: 1px solid #e94560; }
        .btn-replace:hover { background: #7a2a40; }
    </style>
</head>
<body>
    <header>
        <div>
            <h1>Sources</h1>
            <p>Manage your content sources and packs</p>
        </div>
        {% with active_page='sources' %}{% include '_nav.html' %}{% endwith %}
    </header>

    <div class="container">
        <!-- Sub-navigation -->
        <div class="sub-nav">
            <a href="/useradmin/sources" class="active">All Sources</a>
            <a href="/useradmin/sources/tools">Source Tools</a>
        </div>

        <!-- Tabs for filtering -->
        <div class="section">
            <div class="tabs">
                <button class="tab active" data-filter="all">All</button>
                <button class="tab" data-filter="installed">Installed</button>
                <button class="tab" data-filter="available">Available</button>
                <button class="tab" data-filter="local">Local Only</button>
                <button class="tab" data-filter="languages">Languages</button>
                <button class="tab" data-filter="models">LLM Models</button>
            </div>

            <!-- All tab content - shows 4 sections -->
            <div id="allTabContent">
                <h3 style="color: #4ecca3; margin: 1rem 0 0.5rem 0; font-size: 0.95rem;">Local Sources</h3>
                <div id="localSection" class="source-grid">
                    <div class="loading">Loading...</div>
                </div>

                <h3 style="color: #4ecca3; margin: 1.5rem 0 0.5rem 0; font-size: 0.95rem;">Installed Sources</h3>
                <div id="installedSection" class="source-grid">
                    <div class="loading">Loading...</div>
                </div>

                <h3 style="color: #4ecca3; margin: 1.5rem 0 0.5rem 0; font-size: 0.95rem;">Languages</h3>
                <div id="languagesSection" class="source-grid">
                    <div class="placeholder">Language packs coming soon</div>
                </div>

                <h3 style="color: #4ecca3; margin: 1.5rem 0 0.5rem 0; font-size: 0.95rem;">LLM Models</h3>
                <div id="modelsSection" class="source-grid">
                    <div class="placeholder">LLM model management coming soon</div>
                </div>
            </div>

            <!-- Single filter tab content -->
            <div id="filterTabContent" style="display: none;">
                <div id="sourcesList" class="source-grid">
                    <div class="loading">Loading sources...</div>
                </div>
            </div>

            <!-- Languages tab placeholder -->
            <div id="languagesTabContent" style="display: none;">
                <div class="placeholder">Language packs coming soon. Configure language filters for ZIM indexing and download language-specific content packs.</div>
            </div>

            <!-- Models tab placeholder -->
            <div id="modelsTabContent" style="display: none;">
                <div class="placeholder">LLM model management coming soon. Download and manage local LLM models for offline AI capabilities.</div>
            </div>
        </div>
    </div>

    <script>
        let allSources = [];
        let currentFilter = 'all';

        // Pending install state for sync mode modal
        let pendingInstallSourceId = null;
        let pendingInstallIncludeBackup = false;
        let pendingInstallButton = null;
        let pendingInstallOriginalText = '';

        async function loadSources() {
            const container = document.getElementById('sourcesList');
            container.innerHTML = '<div class="loading">Loading sources...</div>';

            try {
                // Fetch local sources
                const localResp = await fetch('/useradmin/api/local-sources');
                const localData = await localResp.json();
                const localSources = localData.sources || [];

                // Fetch cloud/global sources
                let cloudSources = [];
                try {
                    const cloudResp = await fetch('/useradmin/api/cloud-sources');
                    const cloudData = await cloudResp.json();
                    cloudSources = cloudData.sources || [];
                } catch (e) {
                    console.log('Cloud sources not available:', e);
                }

                // Build combined list with status
                const localIds = new Set(localSources.map(s => s.source_id));
                const cloudIds = new Set(cloudSources.map(s => s.source_id));

                allSources = [];

                // Add local sources with status
                for (const source of localSources) {
                    const isInCloud = cloudIds.has(source.source_id);
                    allSources.push({
                        ...source,
                        status: isInCloud ? 'installed' : 'local_only',
                        is_cloud: isInCloud,
                        is_local: true
                    });
                }

                // Add cloud sources (mark if installed locally)
                for (const source of cloudSources) {
                    const isLocal = localIds.has(source.source_id);
                    if (!isLocal) {
                        // Not installed locally - add as available
                        allSources.push({
                            ...source,
                            status: 'available',
                            is_cloud: true,
                            is_local: false
                        });
                    }
                    // Note: installed cloud sources are already added above from localSources
                }

                renderSources();
            } catch (e) {
                container.innerHTML = '<div class="placeholder">Error loading sources: ' + e.message + '</div>';
            }
        }

        function renderSources() {
            // Handle "All" tab - show sectioned view
            if (currentFilter === 'all') {
                document.getElementById('allTabContent').style.display = 'block';
                document.getElementById('filterTabContent').style.display = 'none';
                document.getElementById('languagesTabContent').style.display = 'none';
                document.getElementById('modelsTabContent').style.display = 'none';

                // Render Local section
                const localSources = allSources.filter(s => s.status === 'local_only');
                const localContainer = document.getElementById('localSection');
                if (localSources.length === 0) {
                    localContainer.innerHTML = '<div class="placeholder">No local-only sources</div>';
                } else {
                    localContainer.innerHTML = localSources.map(s => renderSourceCard(s)).join('');
                }

                // Render Installed section
                const installedSources = allSources.filter(s => s.status === 'installed');
                const installedContainer = document.getElementById('installedSection');
                if (installedSources.length === 0) {
                    installedContainer.innerHTML = '<div class="placeholder">No installed sources</div>';
                } else {
                    installedContainer.innerHTML = installedSources.map(s => renderSourceCard(s)).join('');
                }

                return;
            }

            // Handle Languages tab
            if (currentFilter === 'languages') {
                document.getElementById('allTabContent').style.display = 'none';
                document.getElementById('filterTabContent').style.display = 'none';
                document.getElementById('languagesTabContent').style.display = 'block';
                document.getElementById('modelsTabContent').style.display = 'none';
                return;
            }

            // Handle Models tab
            if (currentFilter === 'models') {
                document.getElementById('allTabContent').style.display = 'none';
                document.getElementById('filterTabContent').style.display = 'none';
                document.getElementById('languagesTabContent').style.display = 'none';
                document.getElementById('modelsTabContent').style.display = 'block';
                return;
            }

            // Handle other filter tabs (Installed, Available, Local Only)
            document.getElementById('allTabContent').style.display = 'none';
            document.getElementById('filterTabContent').style.display = 'block';
            document.getElementById('languagesTabContent').style.display = 'none';
            document.getElementById('modelsTabContent').style.display = 'none';

            const container = document.getElementById('sourcesList');

            // Filter based on current tab
            let filtered = allSources;
            if (currentFilter === 'installed') {
                filtered = allSources.filter(s => s.status === 'installed');
            } else if (currentFilter === 'available') {
                // Show ALL cloud sources (both installed and not)
                filtered = allSources.filter(s => s.is_cloud === true);
            } else if (currentFilter === 'local') {
                filtered = allSources.filter(s => s.status === 'local_only');
            }

            if (filtered.length === 0) {
                let message = 'No sources found.';
                if (currentFilter === 'installed') {
                    message = 'No installed sources. Sources from the global cloud that you have locally appear here.';
                } else if (currentFilter === 'available') {
                    message = 'No sources available from the global cloud. Check your cloud connection.';
                } else if (currentFilter === 'local') {
                    message = 'No local-only sources. Custom sources you create that are not in the global cloud appear here.';
                }
                container.innerHTML = `<div class="placeholder">${message}</div>`;
                return;
            }

            container.innerHTML = filtered.map(source => renderSourceCard(source)).join('');
        }

        function renderSourceCard(source) {
            // Status badge
            let statusBadge = '';
            let statusColor = '#888';
            if (source.status === 'installed') {
                statusBadge = 'Installed';
                statusColor = '#4ecca3';
            } else if (source.status === 'available') {
                statusBadge = 'Available';
                statusColor = '#f9a825';
            } else if (source.status === 'local_only') {
                statusBadge = 'Local Only';
                statusColor = '#888';
            }

            // Build status boxes for local sources
            let statusBoxesHtml = '';
            if (source.status !== 'available') {
                const hasConfig = source.has_config !== false;
                const hasBackup = source.has_backup !== false;
                const hasMetadata = source.has_metadata === true;
                const hasEmbeddings = source.has_embeddings === true;
                const hasLicense = source.license && source.license !== 'Unknown';

                statusBoxesHtml = `
                    <div class="status-boxes">
                        <span class="status-box ${hasConfig ? 'ok' : 'missing'}">Config</span>
                        <span class="status-box ${hasBackup ? 'ok' : 'missing'}">Backup</span>
                        <span class="status-box ${hasMetadata ? 'ok' : 'missing'}">Metadata</span>
                        <span class="status-box ${hasEmbeddings ? 'ok' : 'warning'}">Index</span>
                        <span class="status-box ${hasLicense ? 'ok' : 'warning'}">License</span>
                    </div>
                `;
            }

            return `
                <div class="source-card">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <h3 style="margin: 0;">${escapeHtml(source.name || source.source_id)}</h3>
                        <span style="font-size: 0.7rem; padding: 0.2rem 0.5rem; background: ${statusColor}20; color: ${statusColor}; border-radius: 3px;">${statusBadge}</span>
                    </div>
                    <div class="meta">
                        <div>${(source.document_count || 0).toLocaleString()} documents</div>
                        ${source.backup_type ? `<div>${source.backup_type} backup</div>` : ''}
                        <div>${source.license && source.license !== 'Unknown' ? source.license : 'Unknown license'}</div>
                    </div>
                    ${statusBoxesHtml}
                    <div class="actions">
                        ${source.is_local ? `
                            <button class="btn-small btn-edit" onclick="window.location.href='/useradmin/sources/tools?source=${source.source_id}&step=2'">
                                Edit
                            </button>
                            ${source.is_cloud ? `<span style="color: #4ecca3; font-size: 0.7rem; margin-left: 0.5rem;">(from cloud)</span>` : ''}
                        ` : source.is_cloud ? `
                            <button class="btn-small btn-install" onclick="installSource('${source.source_id}', false)" title="Download vectors only for search">
                                Index Only
                            </button>
                            <button class="btn-small btn-install" onclick="installSource('${source.source_id}', true)" style="background: #1a5f3c;" title="Download vectors + backup files for offline viewing">
                                Full Install
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function installSource(sourceId, includeBackup = false) {
            // Find the button and disable it
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Checking...';
            btn.style.opacity = '0.7';

            try {
                // Check if source already exists locally
                const checkResponse = await fetch(`/useradmin/api/local-source-check/${sourceId}`);
                const checkData = await checkResponse.json();

                if (checkData.exists && checkData.vector_count > 0) {
                    // Source exists locally - show modal to choose update or replace
                    pendingInstallSourceId = sourceId;
                    pendingInstallIncludeBackup = includeBackup;
                    pendingInstallButton = btn;
                    pendingInstallOriginalText = originalText;

                    document.getElementById('modalSourceId').textContent = sourceId;
                    document.getElementById('modalVectorCount').textContent = checkData.vector_count.toLocaleString();
                    document.getElementById('syncModeModal').classList.add('show');
                    return;
                }

                // Source doesn't exist locally - proceed with normal install
                await doInstall(sourceId, includeBackup, 'update', btn, originalText);
            } catch (e) {
                alert('Error: ' + e.message);
                btn.textContent = originalText;
                btn.disabled = false;
                btn.style.opacity = '1';
            }
        }

        function closeSyncModal() {
            document.getElementById('syncModeModal').classList.remove('show');
            // Reset button state
            if (pendingInstallButton) {
                pendingInstallButton.textContent = pendingInstallOriginalText;
                pendingInstallButton.disabled = false;
                pendingInstallButton.style.opacity = '1';
            }
            pendingInstallSourceId = null;
            pendingInstallIncludeBackup = false;
            pendingInstallButton = null;
            pendingInstallOriginalText = '';
        }

        async function proceedWithSync(syncMode) {
            console.log('proceedWithSync called with:', syncMode);
            console.log('pendingInstallSourceId:', pendingInstallSourceId);
            console.log('pendingInstallButton:', pendingInstallButton);

            document.getElementById('syncModeModal').classList.remove('show');

            if (!pendingInstallSourceId || !pendingInstallButton) {
                console.error('No pending install - state was cleared');
                alert('Error: Install state was lost. Please try again.');
                return;
            }

            try {
                await doInstall(
                    pendingInstallSourceId,
                    pendingInstallIncludeBackup,
                    syncMode,
                    pendingInstallButton,
                    pendingInstallOriginalText
                );
            } catch (e) {
                console.error('proceedWithSync error:', e);
                alert('Error: ' + e.message);
            }

            // Reset pending state
            pendingInstallSourceId = null;
            pendingInstallIncludeBackup = false;
            pendingInstallButton = null;
            pendingInstallOriginalText = '';
        }

        async function doInstall(sourceId, includeBackup, syncMode, btn, originalText) {
            btn.textContent = syncMode === 'replace' ? 'Replacing...' : 'Starting...';

            try {
                const response = await fetch('/useradmin/api/download-pack', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source_id: sourceId,
                        include_backup: includeBackup,
                        sync_mode: syncMode
                    })
                });

                const data = await response.json();

                if (response.ok && data.status === 'submitted') {
                    // Job submitted successfully - show progress
                    btn.textContent = 'Downloading...';
                    pollJobStatus(data.job_id, btn, sourceId, originalText);
                } else if (response.status === 409) {
                    // Job already running
                    alert('A download is already in progress for this source.');
                    btn.textContent = originalText;
                    btn.disabled = false;
                    btn.style.opacity = '1';
                } else {
                    alert('Failed to start download: ' + (data.detail || 'Unknown error'));
                    btn.textContent = originalText;
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
            } catch (e) {
                alert('Error: ' + e.message);
                btn.textContent = originalText;
                btn.disabled = false;
                btn.style.opacity = '1';
            }
        }

        async function pollJobStatus(jobId, btn, sourceId, originalText) {
            try {
                const response = await fetch(`/useradmin/api/jobs/${jobId}`);
                const job = await response.json();

                if (job.status === 'running' || job.status === 'pending') {
                    // Still running - update button with progress
                    const progress = job.progress || 0;
                    btn.textContent = `${progress}%`;
                    setTimeout(() => pollJobStatus(jobId, btn, sourceId, originalText), 1000);
                } else if (job.status === 'completed') {
                    // Success! Update UI
                    btn.textContent = 'Installed';
                    btn.style.background = '#0f3460';
                    btn.style.color = '#4ecca3';

                    // Refresh sources list after a moment
                    setTimeout(() => {
                        loadSources();
                    }, 1500);
                } else {
                    // Failed
                    alert('Download failed: ' + (job.error || 'Unknown error'));
                    btn.textContent = originalText;
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
            } catch (e) {
                // Polling error - try again
                setTimeout(() => pollJobStatus(jobId, btn, sourceId, originalText), 2000);
            }
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentFilter = tab.dataset.filter;
                renderSources();
            });
        });

        loadSources();
    </script>
    <script src="/admin/static/admin-common.js"></script>

    <!-- Sync Mode Modal -->
    <div id="syncModeModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">Source Already Installed</div>
            <div class="modal-body">
                <p>The source <strong id="modalSourceId"></strong> already exists locally with <span class="count" id="modalVectorCount">0</span> vectors.</p>
                <p>How would you like to proceed?</p>
                <ul style="margin: 1rem 0; padding-left: 1.5rem; color: #aaa; font-size: 0.85rem;">
                    <li><strong>Update:</strong> Add new vectors, keep existing ones</li>
                    <li><strong>Replace:</strong> Delete old vectors first, then install fresh</li>
                </ul>
            </div>
            <div class="modal-actions">
                <button class="btn-small btn-update" id="btnSyncCancel">Cancel</button>
                <button class="btn-small btn-update" id="btnSyncUpdate">Update</button>
                <button class="btn-small btn-replace" id="btnSyncReplace">Replace</button>
            </div>
        </div>
    </div>

    <script>
        // Attach event listeners for modal buttons (CSP-compliant)
        document.getElementById('btnSyncCancel').addEventListener('click', closeSyncModal);
        document.getElementById('btnSyncUpdate').addEventListener('click', function() { proceedWithSync('update'); });
        document.getElementById('btnSyncReplace').addEventListener('click', function() { proceedWithSync('replace'); });
    </script>
</body>
</html>
