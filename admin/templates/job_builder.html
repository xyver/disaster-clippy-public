<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Builder - Disaster Clippy Admin</title>
    <link rel="icon" type="image/png" href="/static/paperclip.png">
    <link rel="stylesheet" href="/admin/static/{{ admin_css }}">
    <style>
        /* Page-specific styles for Job Builder */
        .container { max-width: 1400px; }

        .sub-nav {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .sub-nav a {
            color: #4ecca3;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border: 1px solid #0f3460;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        .sub-nav a:hover { background: #0f3460; }
        .sub-nav a.active { background: #0f3460; color: #e94560; }

        .builder-layout {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 1.5rem;
            min-height: 600px;
        }

        /* Available Jobs Panel */
        .available-jobs {
            background: #1a1a2e;
            border: 1px solid #0f3460;
            border-radius: 6px;
            padding: 1rem;
        }

        .available-jobs h3 {
            color: #4ecca3;
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .job-category {
            margin-bottom: 1rem;
        }

        .category-label {
            color: #888;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .available-job {
            background: #16213e;
            border: 1px solid #0f3460;
            border-radius: 4px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: grab;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .available-job:hover {
            border-color: #4ecca3;
            background: #1a2744;
        }

        .available-job.dragging {
            opacity: 0.5;
        }

        .job-label {
            color: #e0e0e0;
            font-weight: 500;
        }

        .job-add-btn {
            background: #0f3460;
            color: #4ecca3;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
        }

        .job-add-btn:hover {
            background: #4ecca3;
            color: #16213e;
        }

        /* Chain Builder Panel */
        .chain-builder {
            background: #1a1a2e;
            border: 1px solid #0f3460;
            border-radius: 6px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }

        .chain-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .chain-header h3 {
            color: #4ecca3;
            font-size: 1rem;
        }

        .chain-actions {
            display: flex;
            gap: 0.5rem;
        }

        .chain-list {
            flex: 1;
            min-height: 300px;
            background: #16213e;
            border: 2px dashed #0f3460;
            border-radius: 4px;
            padding: 1rem;
            overflow-y: auto;
        }

        .chain-list.drag-over {
            border-color: #4ecca3;
            background: #1a2744;
        }

        .chain-empty {
            color: #666;
            text-align: center;
            padding: 3rem 1rem;
        }

        .chain-item {
            background: #1a1a2e;
            border: 1px solid #0f3460;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            cursor: grab;
        }

        .chain-item.dragging {
            opacity: 0.5;
        }

        .chain-item.selected {
            border-color: #4ecca3;
        }

        .chain-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
        }

        .chain-item-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .chain-item-number {
            background: #0f3460;
            color: #4ecca3;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .chain-item-name {
            color: #e0e0e0;
            font-weight: 500;
        }

        .chain-item-actions {
            display: flex;
            gap: 0.25rem;
        }

        .chain-item-btn {
            background: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            padding: 0.25rem;
            font-size: 0.9rem;
        }

        .chain-item-btn:hover {
            color: #e0e0e0;
        }

        .chain-item-btn.delete:hover {
            color: #e94560;
        }

        .chain-item-params {
            padding: 0.75rem;
            border-top: 1px solid #0f3460;
            display: none;
        }

        .chain-item.expanded .chain-item-params {
            display: block;
        }

        .param-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            gap: 0.75rem;
        }

        .param-label {
            color: #888;
            font-size: 0.85rem;
            min-width: 120px;
        }

        .param-input {
            flex: 1;
            background: #16213e;
            border: 1px solid #0f3460;
            border-radius: 4px;
            padding: 0.4rem 0.6rem;
            color: #e0e0e0;
            font-size: 0.85rem;
        }

        .param-input:focus {
            outline: none;
            border-color: #4ecca3;
        }

        .param-checkbox {
            width: 18px;
            height: 18px;
        }

        /* Footer Actions */
        .chain-footer {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #0f3460;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Config Panel */
        .config-panel {
            background: #1a1a2e;
            border: 1px solid #0f3460;
            border-radius: 6px;
            padding: 1rem;
        }

        .config-panel h3 {
            color: #4ecca3;
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .config-section {
            margin-bottom: 1.5rem;
        }

        .config-section h4 {
            color: #888;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        .source-select {
            width: 100%;
            background: #16213e;
            border: 1px solid #0f3460;
            border-radius: 4px;
            padding: 0.5rem;
            color: #e0e0e0;
            font-size: 0.9rem;
        }

        .source-select:focus {
            outline: none;
            border-color: #4ecca3;
        }

        /* Templates */
        .template-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .template-item {
            background: #16213e;
            border: 1px solid #0f3460;
            border-radius: 4px;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-item:hover {
            border-color: #4ecca3;
        }

        .template-name {
            color: #e0e0e0;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .template-desc {
            color: #888;
            font-size: 0.8rem;
        }

        .template-delete-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: transparent;
            border: 1px solid #5c2030;
            color: #e94560;
            width: 20px;
            height: 20px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: bold;
            line-height: 1;
            padding: 0;
            opacity: 0.6;
            transition: all 0.2s;
        }

        .template-delete-btn:hover {
            opacity: 1;
            background: #5c2030;
        }

        /* Validation Messages */
        .validation-box {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .validation-box.success {
            background: #1a2e1a;
            border: 1px solid #4ecca3;
            color: #4ecca3;
        }

        .validation-box.warning {
            background: #2e2a1a;
            border: 1px solid #f9a825;
            color: #f9a825;
        }

        .validation-box.error {
            background: #2e1a1a;
            border: 1px solid #e94560;
            color: #e94560;
        }

        .validation-list {
            margin-top: 0.5rem;
            padding-left: 1rem;
        }

        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #4ecca3;
            color: #16213e;
            font-weight: 600;
        }

        .btn-primary:hover {
            background: #3dbb92;
        }

        .btn-primary:disabled {
            background: #2d5a4a;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #0f3460;
            color: #e0e0e0;
        }

        .btn-secondary:hover {
            background: #1a4070;
        }

        .btn-danger {
            background: #2e1a1a;
            color: #e94560;
            border: 1px solid #e94560;
        }

        .btn-danger:hover {
            background: #e94560;
            color: #fff;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .builder-layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div>
            <h1>Job Builder</h1>
            <p>Create custom job chains for batch processing</p>
        </div>
        {% with active_page='job_builder' %}{% include '_nav.html' %}{% endwith %}
    </header>

    <div class="container">
        <!-- Sub-navigation -->
        <div class="sub-nav">
            <a href="/useradmin/sources">All Sources</a>
            <a href="/useradmin/sources/tools">Source Tools</a>
            <a href="/useradmin/job-builder" class="active">Job Builder</a>
        </div>

        <div class="builder-layout">
            <!-- Available Jobs -->
            <div class="available-jobs">
                <h3>Available Jobs</h3>
                <div id="availableJobsList">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Chain Builder -->
            <div class="chain-builder">
                <div class="chain-header">
                    <h3>Your Job Chain</h3>
                    <div class="chain-actions">
                        <button class="btn btn-secondary" onclick="clearChain()">Clear</button>
                    </div>
                </div>

                <div id="chainList" class="chain-list"
                     ondragover="handleDragOver(event)"
                     ondrop="handleDrop(event)"
                     ondragleave="handleDragLeave(event)">
                    <div class="chain-empty">
                        Drag jobs here or click + to add them to your chain
                    </div>
                </div>

                <div class="chain-footer">
                    <button class="btn btn-secondary" onclick="validateChain()">Validate</button>
                    <button class="btn btn-primary" onclick="runChain()" id="runBtn" disabled>Run Chain</button>
                    <button class="btn btn-secondary" onclick="saveChain()">Save Template</button>
                </div>

                <div id="validationBox"></div>
            </div>

            <!-- Config Panel -->
            <div class="config-panel">
                <h3>Configuration</h3>

                <div class="config-section">
                    <h4>Target Source</h4>
                    <select id="sourceSelect" class="source-select" onchange="onSourceChange()">
                        <option value="">-- Select a source --</option>
                        <option value="__new__">-- New Source (from job) --</option>
                    </select>
                    <p id="newSourceHint" style="display: none; color: #f9a825; font-size: 0.8rem; margin-top: 0.5rem;">
                        Chain must start with a creation job (ZIM Import, Install, Scrape)
                    </p>
                    <div id="newSourceNameSection" style="display: none; margin-top: 0.75rem;">
                        <label for="newSourceName" style="font-size: 0.85rem; color: #aaa;">Source Name (optional)</label>
                        <input type="text" id="newSourceName" placeholder="e.g. Wikipedia Top 100"
                               style="width: 100%; padding: 0.5rem; margin-top: 0.25rem; background: #16213e; border: 1px solid #0f3460; border-radius: 4px; color: #fff;">
                        <p style="font-size: 0.75rem; color: #666; margin-top: 0.25rem;">
                            Leave blank to auto-derive from filename
                        </p>
                    </div>
                </div>

                <div class="config-section">
                    <h4>Predefined Templates</h4>
                    <div id="templateList" class="template-list">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div class="config-section">
                    <h4>Saved Templates</h4>
                    <div id="savedTemplates" class="template-list">
                        <div class="template-item" style="color: #666;">
                            No saved templates yet
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/admin/static/admin-common.js"></script>
    <script>
        // State
        let jobSchemas = {};
        let predefinedChains = {};
        let chain = [];
        let selectedSource = '';
        let currentTemplateKey = null;  // Track which predefined template was loaded
        let savedTemplates = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadSchemas();
            await loadSources();
            loadSavedTemplates();
            renderAvailableJobs();
            renderTemplates();
            renderChain();
        });

        // Load job schemas from API
        async function loadSchemas() {
            try {
                const resp = await fetch('/useradmin/api/job-builder/schemas');
                const data = await resp.json();
                jobSchemas = data.jobs || {};
                predefinedChains = data.predefined_chains || {};
            } catch (e) {
                console.error('Failed to load schemas:', e);
                showToast('Failed to load job schemas', 'error');
            }
        }

        // Load sources for dropdown
        async function loadSources() {
            try {
                const resp = await fetch('/useradmin/api/local-sources');
                const data = await resp.json();
                const select = document.getElementById('sourceSelect');

                (data.sources || []).forEach(src => {
                    const opt = document.createElement('option');
                    opt.value = src.source_id;
                    opt.textContent = src.name || src.source_id;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error('Failed to load sources:', e);
            }
        }

        // Load saved templates from localStorage
        function loadSavedTemplates() {
            try {
                savedTemplates = JSON.parse(localStorage.getItem('jobBuilderTemplates') || '[]');
            } catch (e) {
                savedTemplates = [];
            }
        }

        // Render available jobs by category
        function renderAvailableJobs() {
            const container = document.getElementById('availableJobsList');
            container.innerHTML = '';

            const categories = {};
            Object.entries(jobSchemas).forEach(([type, schema]) => {
                const cat = schema.category || 'other';
                if (!categories[cat]) categories[cat] = [];
                categories[cat].push({ type, ...schema });
            });

            const categoryOrder = ['content', 'indexing', 'maintenance', 'cloud'];
            categoryOrder.forEach(cat => {
                if (!categories[cat]) return;

                const div = document.createElement('div');
                div.className = 'job-category';
                div.innerHTML = `<div class="category-label">${cat}</div>`;

                categories[cat].forEach(job => {
                    const item = document.createElement('div');
                    item.className = 'available-job';
                    item.draggable = true;
                    item.dataset.jobType = job.type;
                    item.innerHTML = `
                        <span class="job-label">${job.label}</span>
                        <button class="job-add-btn" onclick="addJobToChain('${job.type}')">+</button>
                    `;
                    item.addEventListener('dragstart', handleDragStart);
                    item.addEventListener('dragend', handleDragEnd);
                    item.title = job.description;
                    div.appendChild(item);
                });

                container.appendChild(div);
            });
        }

        // Render predefined templates
        function renderTemplates() {
            const container = document.getElementById('templateList');
            container.innerHTML = '';

            Object.entries(predefinedChains).forEach(([key, tmpl]) => {
                const item = document.createElement('div');
                item.className = 'template-item';
                item.innerHTML = `
                    <div class="template-name">${tmpl.name}</div>
                    <div class="template-desc">${tmpl.description}</div>
                `;
                item.onclick = () => loadTemplate(key);
                container.appendChild(item);
            });

            // Render saved templates
            const savedContainer = document.getElementById('savedTemplates');
            if (savedTemplates.length === 0) {
                savedContainer.innerHTML = '<div class="template-item" style="color: #666;">No saved templates yet</div>';
            } else {
                savedContainer.innerHTML = '';
                savedTemplates.forEach((tmpl, idx) => {
                    const item = document.createElement('div');
                    item.className = 'template-item';
                    item.style.position = 'relative';
                    item.innerHTML = `
                        <div class="template-name">${tmpl.name}</div>
                        <div class="template-desc">${tmpl.phases.length} jobs</div>
                        <button class="template-delete-btn" onclick="event.stopPropagation(); deleteSavedTemplate(${idx});" title="Delete template">X</button>
                    `;
                    item.onclick = () => loadSavedTemplate(idx);
                    savedContainer.appendChild(item);
                });
            }
        }

        // Delete a saved template
        function deleteSavedTemplate(idx) {
            const tmpl = savedTemplates[idx];
            if (!tmpl) return;

            if (!confirm(`Delete template "${tmpl.name}"?`)) return;

            savedTemplates.splice(idx, 1);
            localStorage.setItem('jobBuilderTemplates', JSON.stringify(savedTemplates));
            renderTemplates();
            showToast('Template deleted', 'success');
        }

        // Load a predefined template
        function loadTemplate(key) {
            const tmpl = predefinedChains[key];
            if (!tmpl) return;

            currentTemplateKey = key;  // Track which template was loaded
            chain = tmpl.phases.map((p, i) => ({
                id: Date.now() + i,
                job_type: p.job_type,
                params: { ...p.params },
                expanded: false
            }));
            renderChain();
            validateChain();
        }

        // Load a saved template
        function loadSavedTemplate(idx) {
            const tmpl = savedTemplates[idx];
            if (!tmpl) return;

            currentTemplateKey = null;  // User-saved templates use their own name
            chain = tmpl.phases.map((p, i) => ({
                id: Date.now() + i,
                job_type: p.job_type,
                params: { ...p.params },
                expanded: false
            }));
            renderChain();
            validateChain();
        }

        // Add job to chain
        function addJobToChain(jobType) {
            const schema = jobSchemas[jobType];
            if (!schema) return;

            currentTemplateKey = null;  // Reset - chain is now custom

            // Build default params
            const params = {};
            (schema.params || []).forEach(p => {
                params[p.name] = p.default;
            });

            chain.push({
                id: Date.now(),
                job_type: jobType,
                params,
                expanded: false
            });

            renderChain();
            validateChain();
        }

        // Render the chain
        function renderChain() {
            const container = document.getElementById('chainList');

            if (chain.length === 0) {
                container.innerHTML = '<div class="chain-empty">Drag jobs here or click + to add them to your chain</div>';
                document.getElementById('runBtn').disabled = true;
                return;
            }

            container.innerHTML = '';
            chain.forEach((item, idx) => {
                const schema = jobSchemas[item.job_type] || {};
                const div = document.createElement('div');
                div.className = 'chain-item' + (item.expanded ? ' expanded' : '');
                div.draggable = true;
                div.dataset.index = idx;

                div.innerHTML = `
                    <div class="chain-item-header">
                        <div class="chain-item-left">
                            <span class="chain-item-number">${idx + 1}</span>
                            <span class="chain-item-name">${schema.label || item.job_type}</span>
                        </div>
                        <div class="chain-item-actions">
                            <button class="chain-item-btn" onclick="toggleExpand(${idx})" title="Configure">...</button>
                            <button class="chain-item-btn" onclick="moveUp(${idx})" title="Move up">^</button>
                            <button class="chain-item-btn" onclick="moveDown(${idx})" title="Move down">v</button>
                            <button class="chain-item-btn delete" onclick="removeFromChain(${idx})" title="Remove">x</button>
                        </div>
                    </div>
                    <div class="chain-item-params">
                        ${renderParams(item, schema)}
                    </div>
                `;

                div.addEventListener('dragstart', handleChainDragStart);
                div.addEventListener('dragend', handleChainDragEnd);
                div.addEventListener('dragover', handleChainDragOver);
                div.addEventListener('drop', handleChainDrop);

                container.appendChild(div);
            });
        }

        // Cache for dynamic dropdown options
        let cloudSourcesCache = null;
        let installedLanguagesCache = null;
        let zimFilesCache = null;

        // Load available cloud sources (for install_source job)
        async function loadCloudSources() {
            if (cloudSourcesCache !== null) return cloudSourcesCache;
            try {
                const resp = await fetch('/useradmin/api/available-cloud-sources');
                const data = await resp.json();
                cloudSourcesCache = data.sources || [];
                return cloudSourcesCache;
            } catch (e) {
                console.error('Failed to load cloud sources:', e);
                return [];
            }
        }

        // Load installed languages (for translate_source job)
        async function loadInstalledLanguages() {
            if (installedLanguagesCache !== null) return installedLanguagesCache;
            try {
                const resp = await fetch('/useradmin/api/installed-languages');
                const data = await resp.json();
                installedLanguagesCache = data.languages || [];
                return installedLanguagesCache;
            } catch (e) {
                console.error('Failed to load installed languages:', e);
                return [];
            }
        }

        // Load available ZIM files (for zim_import job)
        async function loadZimFiles() {
            if (zimFilesCache !== null) return zimFilesCache;
            try {
                const resp = await fetch('/useradmin/api/available-zim-files');
                const data = await resp.json();
                zimFilesCache = data.files || [];
                return zimFilesCache;
            } catch (e) {
                console.error('Failed to load ZIM files:', e);
                return [];
            }
        }

        // Render parameter inputs
        function renderParams(item, schema) {
            if (!schema.params || schema.params.length === 0) {
                return '<div style="color: #666;">No configurable parameters</div>';
            }

            return schema.params.map(p => {
                const value = item.params[p.name] !== undefined ? item.params[p.name] : p.default;

                if (p.type === 'bool') {
                    return `
                        <div class="param-row">
                            <span class="param-label">${p.label}</span>
                            <input type="checkbox" class="param-checkbox"
                                   ${value ? 'checked' : ''}
                                   onchange="updateParam(${item.id}, '${p.name}', this.checked)"
                                   title="${p.description}">
                        </div>
                    `;
                } else if (p.type === 'select') {
                    return `
                        <div class="param-row">
                            <span class="param-label">${p.label}</span>
                            <select class="param-input"
                                    onchange="updateParam(${item.id}, '${p.name}', this.value)"
                                    title="${p.description}">
                                ${p.options.map(opt => `<option value="${opt}" ${value == opt ? 'selected' : ''}>${opt}</option>`).join('')}
                            </select>
                        </div>
                    `;
                } else if (p.type === 'cloud_source_select') {
                    // Dynamic dropdown for cloud sources to install
                    const selectId = `cloud-source-${item.id}`;
                    // Load options asynchronously
                    setTimeout(() => loadAndPopulateCloudSources(selectId, item.id, p.name, value), 0);
                    return `
                        <div class="param-row">
                            <span class="param-label">${p.label}</span>
                            <select class="param-input" id="${selectId}"
                                    onchange="updateParam(${item.id}, '${p.name}', this.value)"
                                    title="${p.description}">
                                <option value="">Loading sources...</option>
                            </select>
                        </div>
                    `;
                } else if (p.type === 'language_select') {
                    // Dynamic dropdown for installed languages
                    const selectId = `lang-select-${item.id}`;
                    // Load options asynchronously
                    setTimeout(() => loadAndPopulateLanguages(selectId, item.id, p.name, value), 0);
                    return `
                        <div class="param-row">
                            <span class="param-label">${p.label}</span>
                            <select class="param-input" id="${selectId}"
                                    onchange="updateParam(${item.id}, '${p.name}', this.value)"
                                    title="${p.description}">
                                <option value="">Loading languages...</option>
                            </select>
                        </div>
                    `;
                } else if (p.type === 'zim_file_select') {
                    // Dynamic dropdown for ZIM files in backup folder
                    const selectId = `zim-file-${item.id}`;
                    // Load options asynchronously
                    setTimeout(() => loadAndPopulateZimFiles(selectId, item.id, p.name, value), 0);
                    return `
                        <div class="param-row">
                            <span class="param-label">${p.label}</span>
                            <select class="param-input" id="${selectId}"
                                    onchange="updateParam(${item.id}, '${p.name}', this.value)"
                                    title="${p.description}">
                                <option value="">Scanning for ZIM files...</option>
                            </select>
                        </div>
                    `;
                } else if (p.type === 'language_code_select') {
                    // Static dropdown for ISO language codes (content filtering)
                    const langCodes = [
                        { code: '', name: '(All Languages)' },
                        { code: 'en', name: 'English' },
                        { code: 'es', name: 'Spanish' },
                        { code: 'fr', name: 'French' },
                        { code: 'de', name: 'German' },
                        { code: 'pt', name: 'Portuguese' },
                        { code: 'ru', name: 'Russian' },
                        { code: 'zh', name: 'Chinese' },
                        { code: 'ja', name: 'Japanese' },
                        { code: 'ar', name: 'Arabic' },
                        { code: 'hi', name: 'Hindi' },
                        { code: 'ko', name: 'Korean' },
                        { code: 'it', name: 'Italian' },
                        { code: 'nl', name: 'Dutch' },
                        { code: 'pl', name: 'Polish' },
                        { code: 'tr', name: 'Turkish' },
                        { code: 'vi', name: 'Vietnamese' },
                        { code: 'th', name: 'Thai' },
                        { code: 'uk', name: 'Ukrainian' },
                        { code: 'id', name: 'Indonesian' }
                    ];
                    return `
                        <div class="param-row">
                            <span class="param-label">${p.label}</span>
                            <select class="param-input"
                                    onchange="updateParam(${item.id}, '${p.name}', this.value)"
                                    title="${p.description}">
                                ${langCodes.map(l => `<option value="${l.code}" ${value === l.code ? 'selected' : ''}>${l.name}</option>`).join('')}
                            </select>
                        </div>
                    `;
                } else {
                    const inputType = p.type === 'int' || p.type === 'float' ? 'number' : 'text';
                    return `
                        <div class="param-row">
                            <span class="param-label">${p.label}</span>
                            <input type="${inputType}" class="param-input"
                                   value="${value || ''}"
                                   ${p.min_value !== null ? `min="${p.min_value}"` : ''}
                                   ${p.max_value !== null ? `max="${p.max_value}"` : ''}
                                   onchange="updateParam(${item.id}, '${p.name}', this.value)"
                                   title="${p.description}">
                        </div>
                    `;
                }
            }).join('');
        }

        // Populate cloud sources dropdown after loading
        async function loadAndPopulateCloudSources(selectId, itemId, paramName, currentValue) {
            const sources = await loadCloudSources();
            const select = document.getElementById(selectId);
            if (!select) return;

            if (sources.length === 0) {
                select.innerHTML = '<option value="">No sources available</option>';
                return;
            }

            let html = '<option value="">-- Select source to install --</option>';
            sources.forEach(src => {
                const srcId = src.source_id || src.id || '';
                const name = src.name || srcId;
                const selected = currentValue === srcId ? 'selected' : '';
                html += `<option value="${srcId}" ${selected}>${name}</option>`;
            });
            select.innerHTML = html;

            // Update param if a value was pre-selected
            if (currentValue && sources.some(s => (s.source_id || s.id) === currentValue)) {
                select.value = currentValue;
            }
        }

        // Populate languages dropdown after loading
        async function loadAndPopulateLanguages(selectId, itemId, paramName, currentValue) {
            const languages = await loadInstalledLanguages();
            const select = document.getElementById(selectId);
            if (!select) return;

            if (languages.length === 0) {
                select.innerHTML = '<option value="">No language packs installed</option>';
                return;
            }

            let html = '<option value="">-- Select target language --</option>';
            languages.forEach(lang => {
                const code = lang.code || '';
                const name = lang.name || code;
                const native = lang.native_name ? ` (${lang.native_name})` : '';
                const selected = currentValue === code ? 'selected' : '';
                html += `<option value="${code}" ${selected}>${name}${native}</option>`;
            });
            select.innerHTML = html;

            // Update param if a value was pre-selected
            if (currentValue && languages.some(l => l.code === currentValue)) {
                select.value = currentValue;
            }
        }

        // Populate ZIM files dropdown after loading
        async function loadAndPopulateZimFiles(selectId, itemId, paramName, currentValue) {
            const files = await loadZimFiles();
            const select = document.getElementById(selectId);
            if (!select) return;

            if (files.length === 0) {
                select.innerHTML = '<option value="">No ZIM files found in backup folder</option>';
                return;
            }

            let html = '<option value="">-- Select ZIM file --</option>';
            files.forEach(f => {
                const path = f.path || '';
                const name = f.name || path;
                const size = f.size_mb ? ` (${f.size_mb} MB)` : '';
                const selected = currentValue === path ? 'selected' : '';
                html += `<option value="${path}" ${selected}>${name}${size}</option>`;
            });
            select.innerHTML = html;

            // Update param if a value was pre-selected
            if (currentValue && files.some(f => f.path === currentValue)) {
                select.value = currentValue;
            }
        }

        // Update a parameter value
        function updateParam(id, name, value) {
            const item = chain.find(c => c.id === id);
            if (item) {
                item.params[name] = value;
            }
        }

        // Toggle expand/collapse
        function toggleExpand(idx) {
            chain[idx].expanded = !chain[idx].expanded;
            renderChain();
        }

        // Move item up
        function moveUp(idx) {
            if (idx === 0) return;
            [chain[idx - 1], chain[idx]] = [chain[idx], chain[idx - 1]];
            renderChain();
            validateChain();
        }

        // Move item down
        function moveDown(idx) {
            if (idx >= chain.length - 1) return;
            [chain[idx], chain[idx + 1]] = [chain[idx + 1], chain[idx]];
            renderChain();
            validateChain();
        }

        // Remove from chain
        function removeFromChain(idx) {
            currentTemplateKey = null;  // Reset - chain is now custom
            chain.splice(idx, 1);
            renderChain();
            validateChain();
        }

        // Clear chain
        function clearChain() {
            currentTemplateKey = null;  // Reset
            chain = [];
            renderChain();
            document.getElementById('validationBox').innerHTML = '';
        }

        // Drag and drop handlers for available jobs
        let draggedJobType = null;

        function handleDragStart(e) {
            draggedJobType = e.target.dataset.jobType;
            e.target.classList.add('dragging');
        }

        function handleDragEnd(e) {
            draggedJobType = null;
            e.target.classList.remove('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            if (draggedJobType) {
                addJobToChain(draggedJobType);
            }
        }

        // Drag and drop handlers for chain reordering
        let draggedChainIndex = null;

        function handleChainDragStart(e) {
            draggedChainIndex = parseInt(e.currentTarget.dataset.index);
            e.currentTarget.classList.add('dragging');
        }

        function handleChainDragEnd(e) {
            draggedChainIndex = null;
            e.currentTarget.classList.remove('dragging');
        }

        function handleChainDragOver(e) {
            e.preventDefault();
        }

        function handleChainDrop(e) {
            e.preventDefault();
            const targetIndex = parseInt(e.currentTarget.dataset.index);
            if (draggedChainIndex !== null && draggedChainIndex !== targetIndex) {
                const item = chain.splice(draggedChainIndex, 1)[0];
                chain.splice(targetIndex, 0, item);
                renderChain();
                validateChain();
            }
        }

        // Jobs that create/establish a source (must be first if "New Source" selected)
        const CREATION_JOBS = ['zim_import', 'zim_extract', 'install_source', 'scrape', 'scrape_sitemap'];

        // Source change handler
        function onSourceChange() {
            selectedSource = document.getElementById('sourceSelect').value;

            // Show/hide hint and name input for new source
            const hint = document.getElementById('newSourceHint');
            const nameSection = document.getElementById('newSourceNameSection');
            if (selectedSource === '__new__') {
                hint.style.display = 'block';
                nameSection.style.display = 'block';
            } else {
                hint.style.display = 'none';
                nameSection.style.display = 'none';
            }

            validateChain();
        }

        // Validate chain
        async function validateChain() {
            const box = document.getElementById('validationBox');
            const runBtn = document.getElementById('runBtn');

            if (chain.length === 0) {
                box.innerHTML = '';
                runBtn.disabled = true;
                return;
            }

            // Check if source is selected (except for jobs that have their own source param)
            if (!selectedSource) {
                const needsSource = chain.some(c => {
                    const schema = jobSchemas[c.job_type];
                    // install_source uses cloud_source_id param instead of main source
                    if (c.job_type === 'install_source') return false;
                    return schema && schema.requires_source !== false;
                });

                if (needsSource) {
                    box.innerHTML = '<div class="validation-box warning">Please select a target source</div>';
                    runBtn.disabled = true;
                    return;
                }
            }

            // If "New Source" is selected, chain must start with a creation job
            if (selectedSource === '__new__') {
                if (chain.length === 0) {
                    box.innerHTML = '<div class="validation-box warning">Add a creation job (ZIM Import, Install, Scrape) to establish the source</div>';
                    runBtn.disabled = true;
                    return;
                }

                const firstJob = chain[0].job_type;
                if (!CREATION_JOBS.includes(firstJob)) {
                    box.innerHTML = '<div class="validation-box error">First job must be a creation job (ZIM Import, Install, Scrape) when using "New Source"</div>';
                    runBtn.disabled = true;
                    return;
                }
            }

            // Check if install_source jobs have a cloud source selected
            const installSourceWithoutSelection = chain.find(c =>
                c.job_type === 'install_source' && !c.params.cloud_source_id
            );
            if (installSourceWithoutSelection) {
                box.innerHTML = '<div class="validation-box warning">Please select a cloud source to install</div>';
                runBtn.disabled = true;
                return;
            }

            // Check if translate_source jobs have a language selected
            const translateWithoutLanguage = chain.find(c =>
                c.job_type === 'translate_source' && !c.params.language
            );
            if (translateWithoutLanguage) {
                box.innerHTML = '<div class="validation-box warning">Please select a target language for translation</div>';
                runBtn.disabled = true;
                return;
            }

            // Check if zim_import jobs have a ZIM file selected
            const zimWithoutFile = chain.find(c =>
                c.job_type === 'zim_import' && !c.params.zim_path
            );
            if (zimWithoutFile) {
                box.innerHTML = '<div class="validation-box warning">Please select a ZIM file to import</div>';
                runBtn.disabled = true;
                return;
            }

            // Check for base_url warning: if chain has indexing, warn about needing base_url
            const jobTypes = chain.map(c => c.job_type);
            const hasIndexing = jobTypes.some(j => j.includes('index') && !j.includes('clear'));
            const hasDetectBaseUrl = jobTypes.includes('detect_base_url');

            let baseUrlWarning = '';
            if (hasIndexing && !hasDetectBaseUrl) {
                baseUrlWarning = '<li style="color: #e94560;">IMPORTANT: Make sure base_url is set before indexing. Add "Detect Base URL" or set manually in source editor.</li>';
            }

            // Call API to validate (pass source_id for state-aware validation)
            try {
                const resp = await fetch('/useradmin/api/job-builder/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_types: jobTypes,
                        source_id: selectedSource === '__new__' ? null : selectedSource
                    })
                });
                const result = await resp.json();

                if (result.errors && result.errors.length > 0) {
                    box.innerHTML = `
                        <div class="validation-box error">
                            Errors found:
                            <ul class="validation-list">
                                ${result.errors.map(e => `<li>${e}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                    runBtn.disabled = true;
                } else if (result.warnings && result.warnings.length > 0 || baseUrlWarning) {
                    const warnings = result.warnings || [];
                    box.innerHTML = `
                        <div class="validation-box warning">
                            Notes:
                            <ul class="validation-list">
                                ${baseUrlWarning}
                                ${warnings.map(w => `<li>${w}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                    runBtn.disabled = false;
                } else {
                    box.innerHTML = '<div class="validation-box success">Chain is valid</div>';
                    runBtn.disabled = false;
                }
            } catch (e) {
                box.innerHTML = '<div class="validation-box error">Failed to validate chain</div>';
                runBtn.disabled = true;
            }
        }

        // Generate a descriptive name for the chain
        function generateChainName(chainItems) {
            // Predefined template names (short, descriptive)
            const TEMPLATE_NAMES = {
                'source_prepare': 'HTML Prep',
                'zim_prepare': 'ZIM Prep',
                'index_and_tag': 'Full Idx',
                'index_online_only': 'Cloud Idx',
                'index_offline_only': 'Local Idx',
                'reindex_online': 'Reidx1536',
                'reindex_offline': 'Reidx768',
                'cloud_publish': 'Upload'
            };

            // If a predefined template was loaded unchanged, use its name
            if (currentTemplateKey && TEMPLATE_NAMES[currentTemplateKey]) {
                return TEMPLATE_NAMES[currentTemplateKey];
            }

            // Individual job type abbreviations
            const JOB_ABBREVS = {
                'metadata': 'meta',
                'index_online': 'idx1536',
                'index_offline': 'idx',  // Will add dimension dynamically
                'suggest_tags': 'tags',
                'clear_vectors': 'clear',
                'zim_import': 'zim',
                'detect_base_url': 'url',
                'pinecone_sync': 'pinecone',
                'visualisation': 'viz',
                'scrape': 'scrape',
                'upload': 'upload',
                'install_source': 'install',
                'delete_source': 'delete',
                'translate_source': 'translate'
            };

            // Build name from job types
            const parts = chainItems.map(item => {
                const jobType = item.job_type;
                let abbrev = JOB_ABBREVS[jobType] || jobType;

                // For index_offline, append the dimension
                if (jobType === 'index_offline' && item.params && item.params.dimension) {
                    abbrev = 'idx' + item.params.dimension;
                }
                // For clear_vectors, append the dimension
                if (jobType === 'clear_vectors' && item.params && item.params.dimension) {
                    abbrev = 'clear' + item.params.dimension;
                }

                return abbrev;
            });

            // Join with + and limit length
            let name = parts.join('+');
            if (name.length > 30) {
                name = name.substring(0, 27) + '...';
            }

            return name || 'custom_chain';
        }

        // Run the chain
        async function runChain() {
            if (chain.length === 0) return;

            const runBtn = document.getElementById('runBtn');
            runBtn.disabled = true;
            runBtn.textContent = 'Starting...';

            try {
                const phases = chain.map(c => ({
                    job_type: c.job_type,
                    params: c.params
                }));

                // If "New Source" is selected, pass null - backend will get source from first job
                const sourceToSend = selectedSource === '__new__' ? null : selectedSource;
                const sourceName = selectedSource === '__new__' ? (document.getElementById('newSourceName').value.trim() || null) : null;

                // Generate descriptive chain name from phases
                const chainName = generateChainName(chain);

                const resp = await fetch('/useradmin/api/job-builder/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source_id: sourceToSend,
                        source_from_job: selectedSource === '__new__',  // Flag to indicate source comes from job
                        source_name: sourceName,  // Custom display name for new source
                        phases: phases,
                        resumable: true,
                        chain_name: chainName
                    })
                });

                const result = await resp.json();

                if (result.job_id) {
                    showToast(`Job started: ${result.job_id}`, 'success');
                    // Redirect to jobs page to monitor
                    setTimeout(() => {
                        window.location.href = '/useradmin/jobs';
                    }, 1500);
                } else {
                    showToast(result.error || 'Failed to start job', 'error');
                }
            } catch (e) {
                showToast('Failed to start job chain', 'error');
            } finally {
                runBtn.disabled = false;
                runBtn.textContent = 'Run Chain';
            }
        }

        // Save chain as template
        function saveChain() {
            if (chain.length === 0) {
                showToast('Chain is empty', 'error');
                return;
            }

            const name = prompt('Enter template name:');
            if (!name) return;

            const template = {
                name: name,
                phases: chain.map(c => ({
                    job_type: c.job_type,
                    params: { ...c.params }
                }))
            };

            savedTemplates.push(template);
            localStorage.setItem('jobBuilderTemplates', JSON.stringify(savedTemplates));
            renderTemplates();
            showToast('Template saved', 'success');
        }

        // showToast is provided by admin-common.js
    </script>
</body>
</html>
