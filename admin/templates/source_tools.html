<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Source Tools - Disaster Clippy</title>
    <link rel="icon" type="image/png" href="/static/paperclip.png">
    <link rel="stylesheet" href="/admin/static/admin-common.css">
    <style>
        /* Page-specific styles for Source Tools wizard */

        .sub-nav {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .sub-nav a {
            color: #4ecca3;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border: 1px solid #0f3460;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .sub-nav a:hover { background: #0f3460; }
        .sub-nav a.active { background: #0f3460; color: #e94560; }

        /* Wizard Steps */
        .wizard-steps {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .wizard-step {
            flex: 1;
            min-width: 120px;
            text-align: center;
            padding: 1rem 0.5rem;
            background: #1a1a2e;
            border: 1px solid #0f3460;
            border-radius: 4px;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }

        .wizard-step:hover {
            border-color: #4ecca3;
        }

        .wizard-step.active {
            border-color: #e94560;
            color: #e94560;
            background: #16213e;
        }

        .wizard-step.completed {
            border-color: #4ecca3;
            color: #4ecca3;
        }

        .wizard-step.pending {
            border-color: #f9a825;
            color: #f9a825;
        }

        .wizard-step .step-number {
            display: block;
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
            opacity: 0.7;
        }

        .wizard-step .step-title {
            font-weight: 500;
            font-size: 0.9rem;
        }

        /* Step Content */
        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        .section p.description {
            color: #888;
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }

        .source-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: center;
        }

        .source-selector select {
            flex: 1;
            max-width: 400px;
            padding: 0.75rem;
            border: 1px solid #0f3460;
            border-radius: 6px;
            background: #1a1a2e;
            color: #eee;
            font-size: 0.95rem;
        }

        .source-selector select:focus {
            outline: none;
            border-color: #4ecca3;
        }

        .source-info {
            background: #1a1a2e;
            border: 1px solid #0f3460;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .source-info.ready { border-color: #4ecca3; }
        .source-info.needs-work { border-color: #f9a825; }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .info-item {
            background: #0f3460;
            padding: 0.75rem;
            border-radius: 6px;
        }

        .info-item label {
            display: block;
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
        }

        .info-item span {
            color: #4ecca3;
            font-weight: 500;
        }

        .checklist {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background: #0f3460;
        }

        .checklist-item.ok { color: #4ecca3; }
        .checklist-item.missing { color: #e94560; }
        .checklist-item.warning { color: #f9a825; }

        /* Validation Issues Panel */
        .validation-issues-panel {
            background: #0f3460;
            border-radius: 6px;
            padding: 1rem;
        }

        .validation-step-group {
            color: #888;
            font-size: 0.8rem;
            margin-top: 0.75rem;
            margin-bottom: 0.25rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #1a1a2e;
        }

        .validation-step-group:first-child {
            margin-top: 0;
        }

        .validation-issue {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0.75rem;
            margin: 0.25rem 0;
            border-radius: 4px;
            background: #1a1a2e;
            font-size: 0.85rem;
        }

        .validation-issue.error {
            border-left: 3px solid #e94560;
        }

        .validation-issue.warning {
            border-left: 3px solid #f9a825;
        }

        .validation-issue .issue-text {
            flex: 1;
        }

        .validation-issue.error .issue-text { color: #e94560; }
        .validation-issue.warning .issue-text { color: #f9a825; }

        .validation-issue .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            white-space: nowrap;
        }

        /* Source Type Cards */
        .source-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
        }

        .source-type-card {
            background: #1a1a2e;
            border: 2px solid #0f3460;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .source-type-card:hover {
            border-color: #4ecca3;
        }

        .source-type-card.selected {
            border-color: #e94560;
            background: #16213e;
        }

        .source-type-card .icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .source-type-card .title {
            font-weight: 600;
            color: #4ecca3;
            margin-bottom: 0.25rem;
        }

        .source-type-card .desc {
            font-size: 0.8rem;
            color: #888;
        }

        /* Tool Sections */
        .tool-section {
            background: #1a1a2e;
            border: 2px solid #f9a825;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: border-color 0.3s, background 0.1s;
        }

        .tool-section h3 {
            color: #f9a825;
            font-size: 0.95rem;
            margin-bottom: 0.5rem;
            transition: color 0.3s;
        }

        .tool-section.completed {
            border-color: #4ecca3;
        }

        .tool-section.completed h3 {
            color: #4ecca3;
        }

        .tool-section.skipped {
            border-color: #666;
            opacity: 0.7;
        }

        .tool-section.skipped h3 {
            color: #888;
        }

        /* Section completion indicator */
        .tool-section h3::after {
            content: '';
            margin-left: 0.5rem;
        }

        .tool-section.completed h3::after {
            content: '[OK]';
            color: #4ecca3;
            font-size: 0.75rem;
            font-weight: normal;
        }

        .tool-section.skipped h3::after {
            content: '[SKIP]';
            color: #666;
            font-size: 0.75rem;
            font-weight: normal;
        }

        .tool-section p {
            color: #888;
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
        }

        .tool-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Forms */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 0.5rem;
        }

        .form-group input[type="text"],
        .form-group input[type="url"],
        .form-group input[type="number"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #0f3460;
            border-radius: 6px;
            background: #1a1a2e;
            color: #eee;
            font-size: 0.9rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4ecca3;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Page-specific button extensions */
        .btn {
            padding: 0.6rem 1.2rem;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .btn-primary:hover { background: #3db892; }
        .btn-secondary:hover { background: #1a4a7a; }
        .btn-danger:hover { background: #d53a54; }

        .btn-warning {
            background: #f9a825;
            color: #1a1a2e;
        }
        .btn-warning:hover { background: #e09620; }

        /* Navigation Buttons */
        .step-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #0f3460;
        }

        /* Output Log */
        .output-log {
            background: #0a0a14;
            border: 1px solid #0f3460;
            border-radius: 6px;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .output-log .success { color: #4ecca3; }
        .output-log .error { color: #e94560; }
        .output-log .warning { color: #f9a825; }
        .output-log .info { color: #4ecca3; opacity: 0.7; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: #4ecca3;
            color: #1a1a2e;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.error {
            background: #e94560;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #888;
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-v1 { background: #f9a825; color: #1a1a2e; }
        .badge-v2 { background: #4ecca3; color: #1a1a2e; }
        .badge-ready { background: #4ecca3; color: #1a1a2e; }
        .badge-incomplete { background: #e94560; color: white; }

        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .form-row { grid-template-columns: 1fr; }
            .info-grid { grid-template-columns: 1fr; }
            .wizard-steps { flex-direction: column; }
        }

        /* Sync mode modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.show { display: flex; }
        .modal-content {
            background: #1a1a2e;
            border: 1px solid #4ecca3;
            border-radius: 8px;
            padding: 1.5rem;
            max-width: 500px;
            width: 90%;
        }
        .modal-title {
            color: #f9a825;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .modal-body { color: #ccc; font-size: 0.9rem; margin-bottom: 1.5rem; }
        .modal-body strong { color: #4ecca3; }
        .modal-body .count { color: #e94560; font-weight: 600; }
        .modal-actions { display: flex; gap: 0.75rem; justify-content: flex-end; }
        .modal-actions .btn { padding: 0.5rem 1rem; }
    </style>
</head>
<body>
    <header>
        <div>
            <h1>Source Tools</h1>
            <p>Create, configure, and manage content sources</p>
        </div>
        <nav class="nav-links">
            <a href="/useradmin/dashboard">Dashboard</a>
            <a href="/useradmin/sources" class="active">Sources</a>
            <a href="/useradmin/jobs">Jobs</a>
            <a href="/useradmin/cloud">Cloud</a>
            <a href="/useradmin/settings">Settings</a>
            <a href="/useradmin/submissions">Submissions</a>
            <a href="/useradmin/pinecone">Pinecone</a>
            <a href="/">Chat</a>
            <span class="nav-divider"></span>
            <label class="mode-toggle" id="modeToggle" title="Switch between Local and Global mode for testing">
                <input type="checkbox" id="modeCheckbox" onchange="toggleMode()">
                <span class="mode-label" id="modeLabel">Local</span>
                <span class="toggle-slider"></span>
                <span class="mode-badge" id="modeBadge">TEST</span>
            </label>
        </nav>
    </header>

    <div class="container">
        <!-- Sub-navigation -->
        <div class="sub-nav">
            <a href="/useradmin/sources">All Sources</a>
            <a href="/useradmin/sources/tools" class="active">Source Tools</a>
        </div>

        <!-- Wizard Steps -->
        <div class="wizard-steps">
            <div class="wizard-step active" data-step="1" onclick="goToStep(1)">
                <span class="step-number">Step 1</span>
                <span class="step-title">Add Source</span>
            </div>
            <div class="wizard-step" data-step="2" onclick="goToStep(2)">
                <span class="step-number">Step 2</span>
                <span class="step-title">Configure</span>
            </div>
            <div class="wizard-step" data-step="3" onclick="goToStep(3)">
                <span class="step-number">Step 3</span>
                <span class="step-title">Index</span>
            </div>
            <div class="wizard-step" data-step="4" onclick="goToStep(4)">
                <span class="step-number">Step 4</span>
                <span class="step-title">Review</span>
            </div>
            <div class="wizard-step" data-step="5" onclick="goToStep(5)">
                <span class="step-number">Step 5</span>
                <span class="step-title">Validate</span>
            </div>
        </div>

        <!-- Step 1: Add Source -->
        <div class="step-content active" data-step="1">
            <div class="section">
                <h2>Select or Create Source</h2>
                <p class="description">Choose an existing source to edit, or create a new one</p>

                <div class="source-selector">
                    <select id="sourceSelect" onchange="loadSourceDetails()">
                        <option value="">-- Select existing source --</option>
                    </select>
                    <button class="btn btn-secondary" onclick="refreshSources()">Refresh</button>
                </div>

                <div style="text-align: center; margin: 1.5rem 0; color: #666;">- OR -</div>

                <h3 style="color: #4ecca3; margin-bottom: 1rem;">Create New Source</h3>

                <div class="source-type-grid">
                    <div class="source-type-card" onclick="selectSourceType('html')" data-type="html">
                        <div class="icon">[ ]</div>
                        <div class="title">HTML Backup</div>
                        <div class="desc">Import from existing HTML folder</div>
                    </div>
                    <div class="source-type-card" onclick="selectSourceType('zim')" data-type="zim">
                        <div class="icon">[Z]</div>
                        <div class="title">ZIM File</div>
                        <div class="desc">Wikipedia/Kiwix archives</div>
                    </div>
                    <div class="source-type-card" onclick="selectSourceType('pdf')" data-type="pdf">
                        <div class="icon">[P]</div>
                        <div class="title">PDF Collection</div>
                        <div class="desc">Folder of PDF files</div>
                    </div>
                    <div class="source-type-card" onclick="selectSourceType('scrape')" data-type="scrape">
                        <div class="icon">[W]</div>
                        <div class="title">Web Scrape</div>
                        <div class="desc">Scrape a website</div>
                    </div>
                </div>

                <!-- New Source Form (shown when type is selected) -->
                <div id="newSourceForm" style="display: none; margin-top: 1.5rem;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Source ID (slug)</label>
                            <input type="text" id="newSourceId" placeholder="my-source-name">
                            <p style="font-size: 0.8rem; color: #888; margin-top: 0.25rem;">
                                Lowercase letters, numbers, underscores, hyphens. This becomes the folder name.
                            </p>
                        </div>
                        <div class="form-group">
                            <label>Source Type</label>
                            <input type="text" id="newSourceType" readonly style="background: #0a0a14; color: #4ecca3;">
                        </div>
                    </div>
                    <div class="form-group" id="scrapeUrlGroup" style="display: none;">
                        <label>Website URL to Scrape</label>
                        <input type="url" id="scrapeUrl" placeholder="https://example.com">
                    </div>
                    <div class="form-group" id="importPathGroup" style="display: none;">
                        <label>Path to Import (relative to backup folder)</label>
                        <input type="text" id="importPath" placeholder="my-folder or path/to/folder">
                    </div>
                    <div class="form-group" id="zimSelectorGroup" style="display: none;">
                        <label>Select ZIM File</label>
                        <select id="zimFileSelect" onchange="onZimFileSelected()">
                            <option value="">-- Loading ZIM files... --</option>
                        </select>
                        <p style="font-size: 0.8rem; color: #888; margin-top: 0.25rem;">
                            ZIM files found in your backup folder. The file will be moved into the source folder.
                        </p>
                        <div id="zimFileInfo" style="display: none; margin-top: 0.75rem; padding: 0.75rem; background: #0f3460; border-radius: 4px; font-size: 0.85rem;">
                        </div>
                    </div>
                    <div class="tool-actions">
                        <button class="btn btn-primary" onclick="createNewSource()">Create Source</button>
                        <button class="btn btn-secondary" onclick="cancelNewSource()">Cancel</button>
                    </div>
                </div>
            </div>

            <div class="step-navigation">
                <div></div>
                <button class="btn btn-primary" onclick="nextStep()" id="step1Next" disabled>Next: Configure</button>
            </div>
        </div>

        <!-- Step 2: Configure -->
        <div class="step-content" data-step="2">
            <div class="section">
                <h2>Source Configuration</h2>
                <p class="description">Set the display name, license, and description for your source</p>

                <div id="noSourceSelected2" class="empty-state">
                    Please select or create a source in Step 1 first.
                </div>

                <div id="configForm" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Display Name</label>
                            <input type="text" id="editName" placeholder="Human-readable name">
                        </div>
                        <div class="form-group">
                            <label>License</label>
                            <select id="editLicense">
                                <option value="Unknown">Unknown</option>
                                <option value="CC BY 4.0">CC BY 4.0</option>
                                <option value="CC BY 3.0">CC BY 3.0</option>
                                <option value="CC BY-SA 4.0">CC BY-SA 4.0</option>
                                <option value="CC BY-SA 3.0">CC BY-SA 3.0</option>
                                <option value="CC BY-NC 4.0">CC BY-NC 4.0</option>
                                <option value="CC BY-NC-SA 4.0">CC BY-NC-SA 4.0</option>
                                <option value="CC0">CC0 (Public Domain)</option>
                                <option value="GFDL">GFDL (GNU Free Documentation)</option>
                                <option value="MIT">MIT</option>
                                <option value="GPL">GPL</option>
                                <option value="Apache 2.0">Apache 2.0</option>
                                <option value="Fair Use">Fair Use</option>
                                <option value="Custom">Custom</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editDescription" rows="3" placeholder="Brief description of the source content"></textarea>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="editLicenseVerified"> License Verified
                        </label>
                        <p style="font-size: 0.8rem; color: #888; margin-top: 0.25rem;">
                            Check this if you have confirmed the license is accurate
                        </p>
                    </div>
                    <div class="tool-actions">
                        <button class="btn btn-primary" onclick="saveSourceConfig()">Save Configuration</button>
                        <button class="btn btn-secondary" onclick="autoDetect()">Auto-Detect</button>
                    </div>

                    <!-- Rename Section (Admin Only) -->
                    <div class="admin-only" id="renameSection" style="display: none; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #0f3460;">
                        <h3 style="color: #f9a825; margin-bottom: 0.75rem;">Rename Source (Admin Only)</h3>
                        <p style="font-size: 0.85rem; color: #888; margin-bottom: 1rem;">
                            Change the source ID. This will rename the folder and all associated files.
                        </p>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Current Source ID</label>
                                <input type="text" id="renameCurrentId" readonly style="background: #0a0a14; color: #888;">
                            </div>
                            <div class="form-group">
                                <label>New Source ID</label>
                                <input type="text" id="renameNewId" placeholder="new-source-id">
                            </div>
                        </div>
                        <div class="tool-actions">
                            <button class="btn btn-warning" onclick="renameSource()">Rename Source</button>
                        </div>
                    </div>

                    <!-- Scan Backup Section (HTML sources) -->
                    <div class="tool-section" id="scanBackupSection" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #0f3460;">
                        <h3>Scan Backup (HTML sources)</h3>
                        <p>Scan the backup folder and create a manifest of all files. Required for HTML sources before generating metadata.</p>
                        <div class="tool-actions">
                            <button class="btn btn-secondary" id="btnScanBackup" onclick="scanBackup()">Scan Backup</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="step-navigation">
                <button class="btn btn-secondary" onclick="prevStep()">Back</button>
                <button class="btn btn-primary" onclick="nextStep()">Next: Index</button>
            </div>
        </div>

        <!-- Step 3: Index -->
        <div class="step-content" data-step="3">
            <div class="section">
                <h2>Indexing Tools</h2>
                <p class="description">Generate metadata and index for offline search</p>

                <div id="noSourceSelected3" class="empty-state">
                    Please select or create a source in Step 1 first.
                </div>

                <div id="indexTools" style="display: none;">
                    <!-- Source Indicator Banner -->
                    <div id="indexSourceBanner" class="source-banner" style="background: #0f3460; border: 1px solid #4ecca3; border-radius: 6px; padding: 1rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem;">
                        <div style="flex: 1;">
                            <div style="color: #888; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 0.25rem;">Working on source:</div>
                            <div style="color: #4ecca3; font-size: 1.1rem; font-weight: 600;" id="indexSourceName">-</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #888; font-size: 0.75rem;">Type</div>
                            <div style="color: #e94560; font-weight: 500;" id="indexSourceType">-</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #888; font-size: 0.75rem;">Documents</div>
                            <div style="color: #fff; font-weight: 500;" id="indexSourceDocs">-</div>
                        </div>
                    </div>

                    <div class="tool-section" id="sectionGenerateMetadata">
                        <h3>1. Generate Metadata</h3>
                        <p>Extract document titles, content, and create the metadata file. For ZIM files, you can filter by language.</p>

                        <div style="display: flex; gap: 1rem; align-items: flex-end; margin-bottom: 1rem; flex-wrap: wrap;">
                            <div class="form-group" style="margin-bottom: 0; flex: 0 0 200px;">
                                <label>Language Filter (ZIM)</label>
                                <select id="metadataLanguageFilter">
                                    <option value="">All Languages</option>
                                    <optgroup label="Common">
                                        <option value="en">English</option>
                                        <option value="es">Spanish</option>
                                        <option value="fr">French</option>
                                        <option value="pt">Portuguese</option>
                                        <option value="ar">Arabic</option>
                                        <option value="zh">Chinese</option>
                                    </optgroup>
                                    <optgroup label="Humanitarian Priority">
                                        <option value="ht">Haitian Creole</option>
                                        <option value="sw">Swahili</option>
                                        <option value="bn">Bengali</option>
                                        <option value="ne">Nepali</option>
                                        <option value="ur">Urdu</option>
                                        <option value="hi">Hindi</option>
                                        <option value="tl">Tagalog/Filipino</option>
                                        <option value="id">Indonesian</option>
                                    </optgroup>
                                    <optgroup label="European">
                                        <option value="de">German</option>
                                        <option value="it">Italian</option>
                                        <option value="nl">Dutch</option>
                                        <option value="pl">Polish</option>
                                        <option value="uk">Ukrainian</option>
                                        <option value="ru">Russian</option>
                                        <option value="ro">Romanian</option>
                                        <option value="el">Greek</option>
                                        <option value="tr">Turkish</option>
                                    </optgroup>
                                    <optgroup label="Asian">
                                        <option value="ja">Japanese</option>
                                        <option value="ko">Korean</option>
                                        <option value="vi">Vietnamese</option>
                                        <option value="th">Thai</option>
                                        <option value="ms">Malay</option>
                                        <option value="my">Burmese</option>
                                        <option value="km">Khmer</option>
                                        <option value="lo">Lao</option>
                                    </optgroup>
                                    <optgroup label="South Asian">
                                        <option value="ta">Tamil</option>
                                        <option value="te">Telugu</option>
                                        <option value="si">Sinhala</option>
                                    </optgroup>
                                    <optgroup label="Middle East/Africa">
                                        <option value="fa">Persian/Farsi</option>
                                        <option value="he">Hebrew</option>
                                        <option value="am">Amharic</option>
                                    </optgroup>
                                </select>
                            </div>
                            <p style="font-size: 0.8rem; color: #888; margin: 0; flex: 1 1 200px;">
                                Filter multi-language ZIM files to English-only (or other language). Applies to both metadata and index creation below.
                            </p>
                        </div>

                        <div class="tool-actions">
                            <button class="btn btn-primary" id="btnGenerateMetadata" onclick="generateMetadata()">Generate Metadata</button>
                        </div>
                    </div>

                    <div class="tool-section" id="sectionBaseUrl">
                        <h3>2. Configure Base URL (Optional)</h3>
                        <p>For ZIM sources, detect the correct base URL by comparing sample articles with their actual online URLs.</p>

                        <div class="tool-actions" style="margin-bottom: 1rem;">
                            <button class="btn btn-secondary" onclick="loadUrlSamples()">Load Sample Articles</button>
                            <span id="urlSamplesStatus" style="margin-left: 0.5rem; font-size: 0.85rem;"></span>
                        </div>

                        <!-- Sample articles table -->
                        <div id="urlSamplesTable" style="display: none; margin-bottom: 1rem;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                                <thead>
                                    <tr style="border-bottom: 1px solid #333;">
                                        <th style="text-align: left; padding: 0.5rem; width: 25%;">Article Title</th>
                                        <th style="text-align: left; padding: 0.5rem; width: 20%;">Article ID</th>
                                        <th style="text-align: left; padding: 0.5rem; width: 55%;">Paste Actual URL Here</th>
                                    </tr>
                                </thead>
                                <tbody id="urlSamplesBody">
                                    <!-- Sample rows will be inserted here -->
                                </tbody>
                            </table>
                            <p style="font-size: 0.8rem; color: #888; margin-top: 0.5rem;">
                                Find any article online (e.g., search Wikipedia for the title), copy its URL, and paste above. Then click "Detect Pattern".
                            </p>
                            <div class="tool-actions" style="margin-top: 0.75rem;">
                                <button class="btn btn-primary" onclick="detectUrlPattern()">Detect Pattern</button>
                            </div>
                        </div>

                        <!-- Detected/Manual base URL -->
                        <div id="detectedUrlSection" style="display: none; margin-top: 1rem; padding: 1rem; background: #0f3460; border: 1px solid #4ecca3; border-radius: 6px;">
                            <div style="color: #4ecca3; font-weight: 600; margin-bottom: 0.5rem;">Detected Base URL:</div>
                            <div class="form-group" style="margin-bottom: 0.5rem;">
                                <input type="text" id="editBaseUrl" placeholder="https://example.com/wiki/" style="font-family: monospace;" oninput="updateUrlPreview()">
                            </div>
                            <div id="urlPreview" style="font-size: 0.8rem; color: #888; margin-bottom: 0.75rem;">
                                <!-- Preview will show here -->
                            </div>
                            <div class="tool-actions">
                                <button class="btn btn-primary" onclick="saveBaseUrl()">Save Base URL</button>
                                <button class="btn btn-secondary" onclick="testBaseUrl()">Test All Samples</button>
                                <span id="testUrlStatus" style="margin-left: 0.5rem; font-size: 0.85rem;"></span>
                            </div>
                        </div>

                        <!-- Test results -->
                        <div id="testUrlResults" style="display: none; margin-top: 0.75rem; padding: 0.75rem; background: #0a0a14; border-radius: 4px; font-size: 0.85rem;">
                            <!-- Test results will appear here -->
                        </div>

                        <!-- Manual entry option -->
                        <div style="margin-top: 1rem;">
                            <button class="btn btn-small btn-secondary" onclick="showManualBaseUrl()">Or Enter Base URL Manually</button>
                        </div>
                    </div>

                    <div class="tool-section" id="sectionCreateIndex">
                        <h3>3. Create Index</h3>
                        <p>Generate vector embeddings for semantic search. Uses the filtered document list from metadata (no re-scanning ZIM).</p>

                        <!-- Document count display (shown after metadata generation) -->
                        <div id="documentCountDisplay" style="display: none; background: #0f3460; border: 1px solid #4ecca3; border-radius: 6px; padding: 0.75rem 1rem; margin-bottom: 1rem; color: #4ecca3; font-weight: 500;">
                            Source contains 0 documents
                        </div>

                        <div style="display: flex; gap: 1rem; align-items: flex-end; margin-bottom: 1rem; flex-wrap: wrap;">
                            <div class="form-group" style="margin-bottom: 0; flex: 0 0 150px;">
                                <label>Document Limit</label>
                                <input type="number" id="indexLimit" value="1000" min="1" max="50000" placeholder="1000">
                            </div>
                            <p style="font-size: 0.8rem; color: #888; margin: 0; flex: 1 1 200px;">
                                Maximum documents to embed. Language filtering already applied in Step 2.
                            </p>
                        </div>
                        <div class="tool-actions">
                            <button class="btn btn-primary" id="btnCreateIndex" onclick="createIndex()">Create Index</button>
                            <button class="btn btn-secondary" id="btnIndexAll" style="display: none;" onclick="indexAll()">Index All</button>
                            <button class="btn btn-secondary" onclick="createIndex(true)">Force Re-index</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="step-navigation">
                <button class="btn btn-secondary" onclick="prevStep()">Back</button>
                <button class="btn btn-primary" onclick="nextStep()">Next: Review</button>
            </div>
        </div>

        <!-- Step 4: Review -->
        <div class="step-content" data-step="4">
            <div class="section">
                <h2>Review Source</h2>
                <p class="description">Check source completeness and adjust tags based on indexed content</p>

                <div id="noSourceSelected4" class="empty-state">
                    Please select or create a source in Step 1 first.
                </div>

                <div id="reviewContent" style="display: none;">
                    <div id="sourceInfo" class="source-info">
                        <div class="loading">Loading...</div>
                    </div>

                    <!-- Tags Section -->
                    <div class="tool-section" id="sectionTags" style="margin-top: 1.5rem;">
                        <h3>Source Tags</h3>
                        <p>Tags help categorize and filter sources. Suggested tags are based on indexed content.</p>

                        <div class="form-group">
                            <label>Current Tags</label>
                            <input type="text" id="editTags" placeholder="emergency, water, shelter, medical">
                            <p style="font-size: 0.8rem; color: #888; margin-top: 0.25rem;">
                                Comma-separated tags for categorization
                            </p>
                        </div>

                        <div id="suggestedTagsHint" style="display: none; margin-top: 0.5rem; padding: 0.75rem; background: #0a2a1a; border: 1px solid #1a5a3e; border-radius: 4px;">
                            <div style="font-size: 0.8rem; color: #4ecca3; margin-bottom: 0.5rem;">
                                <strong>Suggested Tags:</strong> <span id="suggestedTagsList"></span>
                            </div>
                            <button class="btn btn-secondary" style="padding: 0.3rem 0.75rem; font-size: 0.8rem;" onclick="applySuggestedTags()">Apply Suggested Tags</button>
                        </div>

                        <div class="tool-actions" style="margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="saveTags()">Save Tags</button>
                            <button class="btn btn-secondary" onclick="getSuggestedTags()">Get Suggestions</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="step-navigation">
                <button class="btn btn-secondary" onclick="prevStep()">Back</button>
                <button class="btn btn-primary" onclick="nextStep()">Next: Validate</button>
            </div>
        </div>

        <!-- Step 5: Validate & Share -->
        <div class="step-content" data-step="5">
            <div class="section">
                <h2>Validate & Share</h2>
                <p class="description">Run validation and optionally upload to the cloud</p>

                <div id="noSourceSelected5" class="empty-state">
                    Please select or create a source in Step 1 first.
                </div>

                <div id="validateTools" style="display: none;">
                    <!-- Source Indicator Banner -->
                    <div id="validateSourceBanner" class="source-banner" style="background: #0f3460; border: 1px solid #4ecca3; border-radius: 6px; padding: 1rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem;">
                        <div style="flex: 1;">
                            <div style="color: #888; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 0.25rem;">Validating source:</div>
                            <div style="color: #4ecca3; font-size: 1.1rem; font-weight: 600;" id="validateSourceName">-</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #888; font-size: 0.75rem;">Type</div>
                            <div style="color: #e94560; font-weight: 500;" id="validateSourceType">-</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #888; font-size: 0.75rem;">Status</div>
                            <div id="validateSourceStatus">-</div>
                        </div>
                    </div>

                    <div class="tool-section" id="sectionValidate">
                        <h3>Validate Source</h3>
                        <p>Check if the source meets all requirements for distribution.</p>
                        <div class="tool-actions">
                            <button class="btn btn-primary" onclick="validateSource()">Run Validation</button>
                        </div>

                        <!-- Actionable Issues Panel - shows after validation -->
                        <div id="validationIssuesPanel" class="validation-issues-panel" style="display: none; margin-top: 1rem;">
                            <h4 style="margin-bottom: 0.75rem; color: #f9a825;">Issues to Fix</h4>
                            <div id="validationIssuesList">
                                <!-- Issues will be rendered here by showActionableIssues() -->
                            </div>
                        </div>
                    </div>

                    <div class="tool-section" id="sectionTestLinks">
                        <h3>Test Links</h3>
                        <p>Verify that article URLs are correct for online access. Important before publishing to Pinecone.</p>
                        <div class="tool-actions">
                            <button class="btn btn-secondary" onclick="testLinks()">Test Sample Links</button>
                        </div>
                        <div id="testLinksResults" style="display: none; margin-top: 1rem; font-size: 0.85rem;">
                            <!-- Results will be shown here -->
                        </div>
                    </div>

                    <div class="tool-section admin-only" style="border-color: #4ecca3; display: none;">
                        <h3 style="color: #4ecca3;">Upload to Cloud (Admin)</h3>
                        <p>Upload this source to the global repository for others to use.</p>
                        <div class="tool-actions">
                            <button class="btn btn-primary" onclick="window.location.href='/useradmin/cloud'">Go to Cloud Upload</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="step-navigation">
                <button class="btn btn-secondary" onclick="prevStep()">Back</button>
                <button class="btn btn-primary" onclick="window.location.href='/useradmin/sources'">Done - Back to Sources</button>
            </div>
        </div>

        <!-- Output Log (visible on all steps) -->
        <div class="section">
            <h2>Output Log</h2>
            <div id="outputLog" class="output-log">Ready. Select a source and run a tool to see output here.</div>
        </div>

        <!-- Danger Zone - at very bottom under logs -->
        <div class="section" id="dangerZoneSection" style="display: none;">
            <div class="tool-section" style="border-color: #e94560; margin: 0;">
                <h3 style="color: #e94560;">Danger Zone</h3>
                <p>Delete this source completely (cannot be undone).</p>
                <div class="tool-actions">
                    <button class="btn btn-danger" onclick="deleteSource()">Delete Source</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        let sources = [];
        let currentSource = null;
        let currentStep = 1;
        let selectedSourceType = null;

        // Pending index state for sync mode modal
        let pendingIndexLimit = null;  // null = use input field value
        let pendingIndexLanguageFilter = null;

        // Section completion state tracking
        // Maps section IDs to their completion status
        let sectionState = {
            // Step 2: Configure
            'scanBackupSection': 'pending',
            // Step 3: Index
            'sectionGenerateMetadata': 'pending',
            'sectionBaseUrl': 'pending',
            'sectionCreateIndex': 'pending',
            // Step 4: Review
            'sectionTags': 'pending',
            // Step 5: Validate
            'sectionValidate': 'pending',
            'sectionTestLinks': 'pending'
        };

        // Map steps to their required sections
        const stepSections = {
            2: ['scanBackupSection'],
            3: ['sectionGenerateMetadata', 'sectionCreateIndex'], // sectionBaseUrl is optional
            4: ['sectionTags'],
            5: ['sectionValidate']  // sectionTestLinks is optional
        };

        // Mark a section as completed
        function markSectionComplete(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.remove('pending', 'skipped');
                section.classList.add('completed');
                sectionState[sectionId] = 'completed';
                updateStepCompletion();
                logOutput(`Section completed: ${section.querySelector('h3')?.textContent || sectionId}`, 'success');
            }
        }

        // Mark a section as skipped (optional sections)
        function markSectionSkipped(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.remove('pending', 'completed');
                section.classList.add('skipped');
                sectionState[sectionId] = 'skipped';
            }
        }

        // Reset a section to pending state
        function markSectionPending(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.remove('completed', 'skipped');
                sectionState[sectionId] = 'pending';
            }
        }

        // Reset all sections to pending (when switching sources)
        function resetAllSections() {
            Object.keys(sectionState).forEach(sectionId => {
                markSectionPending(sectionId);
            });
            // Also reset wizard step completion
            document.querySelectorAll('.wizard-step').forEach(el => {
                el.classList.remove('completed', 'pending');
            });
        }

        // Check if a step has all required sections completed
        function isStepComplete(step) {
            const sections = stepSections[step];
            if (!sections) return true;
            return sections.every(sectionId =>
                sectionState[sectionId] === 'completed' || sectionState[sectionId] === 'skipped'
            );
        }

        // Update wizard step indicators based on section completion
        function updateStepCompletion() {
            document.querySelectorAll('.wizard-step').forEach(el => {
                const step = parseInt(el.dataset.step);
                if (step !== currentStep) {
                    // Check if step is complete based on sections
                    if (isStepComplete(step) && step < currentStep) {
                        el.classList.add('completed');
                        el.classList.remove('pending');
                    } else if (step < currentStep) {
                        // Visited but not all sections complete
                        el.classList.add('pending');
                        el.classList.remove('completed');
                    }
                }
            });
        }

        // Initialize section states from source data (when loading existing source)
        function initializeSectionStates(source) {
            if (!source) {
                resetAllSections();
                return;
            }

            // Check what's already done based on source data
            // Step 2: Config is "complete" if manifest exists with name
            if (source.name && source.name !== source.source_id) {
                // Config has been customized - but we track this via save action
            }

            // Step 2: Scan backup complete if backup_manifest exists
            if (source.has_backup) {
                markSectionComplete('scanBackupSection');
            }

            // Step 3: Metadata exists
            if (source.has_metadata) {
                markSectionComplete('sectionGenerateMetadata');
            }

            // Step 3: Base URL configured (optional)
            if (source.base_url) {
                markSectionComplete('sectionBaseUrl');
            } else {
                markSectionSkipped('sectionBaseUrl');
            }

            // Step 3: Index/vectors exist
            if (source.has_vectors || source.has_index) {
                markSectionComplete('sectionCreateIndex');
            }

            // Step 4: Tags exist
            if (source.tags && source.tags.length > 0) {
                markSectionComplete('sectionTags');
            }

            // Step 5: We don't persist validation state, so leave pending
            // unless we want to check if all status boxes are green
            if (source.has_config && source.has_backup && source.has_metadata &&
                source.has_index && source.license_verified) {
                markSectionComplete('sectionValidate');
            }
        }

        // Wizard Navigation
        function goToStep(step) {
            // Only allow going to step if source is selected (except step 1)
            if (step > 1 && !currentSource) {
                showToast('Please select or create a source first', true);
                return;
            }

            currentStep = step;
            updateWizardUI();
        }

        function nextStep() {
            if (currentStep < 5) {
                if (currentStep === 1 && !currentSource) {
                    showToast('Please select or create a source first', true);
                    return;
                }
                currentStep++;
                updateWizardUI();
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateWizardUI();
            }
        }

        function updateWizardUI() {
            // Update step indicators
            document.querySelectorAll('.wizard-step').forEach(el => {
                const step = parseInt(el.dataset.step);
                el.classList.remove('active', 'completed');
                if (step === currentStep) {
                    el.classList.add('active');
                } else if (step < currentStep) {
                    el.classList.add('completed');
                }
            });

            // Show/hide step content
            document.querySelectorAll('.step-content').forEach(el => {
                el.classList.remove('active');
                if (parseInt(el.dataset.step) === currentStep) {
                    el.classList.add('active');
                }
            });

            // Update visibility of source-dependent content
            const hasSource = currentSource !== null;
            document.getElementById('noSourceSelected2').style.display = hasSource ? 'none' : 'block';
            document.getElementById('configForm').style.display = hasSource ? 'block' : 'none';
            document.getElementById('noSourceSelected3').style.display = hasSource ? 'none' : 'block';
            document.getElementById('indexTools').style.display = hasSource ? 'block' : 'none';
            document.getElementById('noSourceSelected4').style.display = hasSource ? 'none' : 'block';
            document.getElementById('reviewContent').style.display = hasSource ? 'block' : 'none';
            document.getElementById('noSourceSelected5').style.display = hasSource ? 'none' : 'block';
            document.getElementById('validateTools').style.display = hasSource ? 'block' : 'none';
            document.getElementById('dangerZoneSection').style.display = hasSource ? 'block' : 'none';

            // Enable/disable step 1 next button
            document.getElementById('step1Next').disabled = !hasSource;

            // Populate step-specific forms when entering that step
            if (hasSource && currentStep === 4) {
                populateTagsForm();
            }
        }

        // Source Type Selection
        let availableZimFiles = [];

        function selectSourceType(type) {
            selectedSourceType = type;

            document.querySelectorAll('.source-type-card').forEach(card => {
                card.classList.remove('selected');
                if (card.dataset.type === type) {
                    card.classList.add('selected');
                }
            });

            document.getElementById('newSourceForm').style.display = 'block';
            document.getElementById('newSourceType').value = type.toUpperCase();

            // Show/hide type-specific fields
            document.getElementById('scrapeUrlGroup').style.display = type === 'scrape' ? 'block' : 'none';
            document.getElementById('importPathGroup').style.display = (type === 'html' || type === 'pdf') ? 'block' : 'none';
            document.getElementById('zimSelectorGroup').style.display = type === 'zim' ? 'block' : 'none';

            // Load ZIM files when ZIM type is selected
            if (type === 'zim') {
                loadAvailableZimFiles();
            }
        }

        async function loadAvailableZimFiles() {
            const select = document.getElementById('zimFileSelect');
            const infoDiv = document.getElementById('zimFileInfo');
            select.innerHTML = '<option value="">-- Loading... --</option>';

            try {
                const response = await fetch('/useradmin/api/zim/list');
                const data = await response.json();

                // Log debug info
                console.log('ZIM list response:', data);

                // Show error if present
                if (data.error) {
                    select.innerHTML = '<option value="">-- Error: ' + data.error + ' --</option>';
                    logOutput(`ZIM list error: ${data.error}`, 'error');
                    return;
                }

                availableZimFiles = data.zim_files || [];

                if (availableZimFiles.length === 0) {
                    const folder = data.backup_folder || 'not configured';
                    const debug = data.debug || {};
                    select.innerHTML = '<option value="">-- No ZIM files found --</option>';

                    // Show helpful info
                    let msg = `No ZIM files found in backup folder: ${folder}`;
                    if (debug.folder_exists === false) {
                        msg += ' (folder does not exist)';
                    } else if (debug.folder_is_dir === false) {
                        msg += ' (path is not a directory)';
                    }
                    logOutput(msg, 'warning');
                    if (infoDiv) {
                        infoDiv.innerHTML = '<span style="color: #ff9800;">Backup folder: ' + folder + '</span>';
                        infoDiv.style.display = 'block';
                    }
                    return;
                }

                select.innerHTML = '<option value="">-- Select a ZIM file --</option>';
                availableZimFiles.forEach(zim => {
                    const option = document.createElement('option');
                    option.value = zim.path;
                    option.textContent = `${zim.name} (${zim.size_mb} MB)${zim.in_subfolder ? ' [in subfolder]' : ''}`;
                    select.appendChild(option);
                });

                logOutput(`Found ${availableZimFiles.length} ZIM file(s) in ${data.backup_folder}`, 'info');

            } catch (e) {
                select.innerHTML = '<option value="">-- Error loading ZIM files --</option>';
                logOutput(`Error loading ZIM files: ${e.message}`, 'error');
                console.error('ZIM list error:', e);
            }
        }

        function onZimFileSelected() {
            const select = document.getElementById('zimFileSelect');
            const infoDiv = document.getElementById('zimFileInfo');
            const selectedPath = select.value;

            if (!selectedPath) {
                infoDiv.style.display = 'none';
                return;
            }

            const zimFile = availableZimFiles.find(z => z.path === selectedPath);
            if (zimFile) {
                // Auto-suggest source ID from filename
                const sourceIdInput = document.getElementById('newSourceId');
                if (!sourceIdInput.value) {
                    // Convert filename to valid source_id
                    let suggestedId = zimFile.name.replace('.zim', '')
                        .toLowerCase()
                        .replace(/[^a-z0-9]+/g, '-')
                        .replace(/^-+|-+$/g, '');
                    sourceIdInput.value = suggestedId;
                }

                // Show file info
                infoDiv.innerHTML = `
                    <div style="color: #4ecca3;"><strong>Selected:</strong> ${zimFile.name}</div>
                    <div style="color: #888; margin-top: 0.25rem;">Size: ${zimFile.size_mb} MB</div>
                    <div style="color: #888;">Path: ${zimFile.path}</div>
                `;
                infoDiv.style.display = 'block';
            }
        }

        function cancelNewSource() {
            selectedSourceType = null;
            document.querySelectorAll('.source-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('newSourceForm').style.display = 'none';
            document.getElementById('newSourceId').value = '';
            document.getElementById('scrapeUrl').value = '';
            document.getElementById('importPath').value = '';
            document.getElementById('zimFileSelect').value = '';
            document.getElementById('zimFileInfo').style.display = 'none';
            document.getElementById('zimSelectorGroup').style.display = 'none';
        }

        async function createNewSource() {
            const sourceId = document.getElementById('newSourceId').value.trim();

            if (!sourceId) {
                showToast('Please enter a source ID', true);
                return;
            }

            if (!/^[a-z0-9][a-z0-9_-]*$/.test(sourceId)) {
                showToast('Invalid source ID format. Use lowercase letters, numbers, underscores, hyphens.', true);
                return;
            }

            // Determine import path based on source type
            let importPath = null;
            if (selectedSourceType === 'zim') {
                const zimSelect = document.getElementById('zimFileSelect');
                importPath = zimSelect.value || null;
                if (!importPath) {
                    showToast('Please select a ZIM file', true);
                    return;
                }
                logOutput(`Creating new source: ${sourceId} (ZIM)...`);
                logOutput(`  ZIM file will be moved to source folder`, 'info');
            } else {
                importPath = document.getElementById('importPath').value || null;
                logOutput(`Creating new source: ${sourceId} (${selectedSourceType})...`);
            }

            try {
                const response = await fetch('/useradmin/api/create-source', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source_id: sourceId,
                        source_type: selectedSourceType,
                        url: document.getElementById('scrapeUrl').value || null,
                        import_path: importPath
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    logOutput(`Source created: ${sourceId}`, 'success');

                    // Log ZIM-specific import info
                    if (data.zim_moved && data.import_info) {
                        logOutput(`  ZIM file moved successfully`, 'success');
                        if (data.import_info.size_mb) {
                            logOutput(`  Size: ${data.import_info.size_mb} MB`, 'info');
                        }
                        if (data.import_info.metadata_extracted) {
                            logOutput(`  Metadata auto-extracted from ZIM`, 'success');
                        }
                    }

                    showToast(data.message || 'Source created successfully');
                    cancelNewSource();
                    await refreshSources();
                    document.getElementById('sourceSelect').value = sourceId;
                    await loadSourceDetails();
                    nextStep();
                } else {
                    logOutput(`Error: ${data.detail || 'Failed to create source'}`, 'error');
                    showToast(data.detail || 'Failed to create source', true);
                }
            } catch (e) {
                logOutput(`Error: ${e.message}`, 'error');
                showToast('Error: ' + e.message, true);
            }
        }

        // Load sources
        async function loadSources() {
            try {
                const response = await fetch('/useradmin/api/local-sources');
                const data = await response.json();
                sources = data.sources || [];

                const select = document.getElementById('sourceSelect');
                const currentValue = select.value;

                select.innerHTML = '<option value="">-- Select existing source --</option>';

                for (const source of sources) {
                    const option = document.createElement('option');
                    option.value = source.source_id;
                    option.textContent = `${source.name || source.source_id} (${source.document_count || 0} docs)`;
                    select.appendChild(option);
                }

                if (currentValue && sources.find(s => s.source_id === currentValue)) {
                    select.value = currentValue;
                }
            } catch (e) {
                logOutput(`Error loading sources: ${e.message}`, 'error');
            }
        }

        async function refreshSources() {
            logOutput('Refreshing sources...');
            await loadSources();
            logOutput('Sources refreshed', 'success');
        }

        async function loadSourceDetails() {
            const sourceId = document.getElementById('sourceSelect').value;

            if (!sourceId) {
                currentSource = null;
                resetAllSections();
                updateWizardUI();
                // Hide document count when no source selected
                document.getElementById('documentCountDisplay').style.display = 'none';
                document.getElementById('btnIndexAll').style.display = 'none';
                return;
            }

            currentSource = sources.find(s => s.source_id === sourceId);

            if (currentSource) {
                // Initialize section states based on what's already done for this source
                initializeSectionStates(currentSource);

                populateEditForm();
                populateTagsForm();
                updateSourceInfo();
                updateSourceBanners();
                updateWizardUI();

                // Show document count if source has documents
                const docCount = currentSource.document_count || 0;
                if (docCount > 0) {
                    updateDocumentCount(docCount);
                } else {
                    document.getElementById('documentCountDisplay').style.display = 'none';
                    document.getElementById('btnIndexAll').style.display = 'none';
                }

                logOutput(`Loaded source: ${currentSource.name || currentSource.source_id}`);
            }
        }

        function updateSourceInfo() {
            const s = currentSource;
            const infoDiv = document.getElementById('sourceInfo');

            const statusClass = s.is_complete ? 'ready' : 'needs-work';
            infoDiv.className = `source-info ${statusClass}`;

            infoDiv.innerHTML = `
                <div class="info-grid">
                    <div class="info-item">
                        <label>Source ID</label>
                        <span>${s.source_id}</span>
                    </div>
                    <div class="info-item">
                        <label>Type</label>
                        <span>${s.backup_type || 'Unknown'}</span>
                    </div>
                    <div class="info-item">
                        <label>Documents</label>
                        <span>${(s.document_count || 0).toLocaleString()}</span>
                    </div>
                    <div class="info-item">
                        <label>Backup Size</label>
                        <span>${(s.backup_size_mb || 0).toFixed(2)} MB</span>
                    </div>
                    <div class="info-item">
                        <label>License</label>
                        <span>${s.license || 'Unknown'}${s.license_verified ? ' (Verified)' : ''}</span>
                    </div>
                    <div class="info-item">
                        <label>Schema</label>
                        <span class="status-badge ${s.schema_version === 2 ? 'badge-v2' : 'badge-v1'}">
                            v${s.schema_version || 1}
                        </span>
                    </div>
                </div>
                <div class="checklist">
                    <span class="checklist-item ${s.has_config ? 'ok' : 'missing'}">${s.has_config ? '[OK]' : '[X]'} Config</span>
                    <span class="checklist-item ${s.has_backup ? 'ok' : 'missing'}">${s.has_backup ? '[OK]' : '[X]'} Backup</span>
                    <span class="checklist-item ${s.has_metadata ? 'ok' : 'missing'}">${s.has_metadata ? '[OK]' : '[X]'} Metadata</span>
                    <span class="checklist-item ${s.has_embeddings ? 'ok' : 'warning'}">${s.has_embeddings ? '[OK]' : '[!]'} Embeddings</span>
                    <span class="checklist-item ${s.license && s.license !== 'Unknown' ? 'ok' : 'warning'}">${s.license && s.license !== 'Unknown' ? '[OK]' : '[!]'} License</span>
                    <span class="checklist-item ${s.license_verified ? 'ok' : 'warning'}">${s.license_verified ? '[OK]' : '[!]'} Verified</span>
                </div>
                ${s.missing && s.missing.length > 0 ? `
                    <div style="margin-top: 1rem; padding: 0.75rem; background: #e9456020; border-radius: 4px; color: #e94560; font-size: 0.85rem;">
                        <strong>Missing:</strong> ${s.missing.join(', ')}
                    </div>
                ` : ''}
            `;
        }

        function updateSourceBanners() {
            // Update Step 3 (Index) banner
            const s = currentSource;
            if (!s) return;

            const displayName = s.name || s.source_id;
            const sourceType = (s.backup_type || 'Unknown').toUpperCase();
            const docCount = (s.document_count || 0).toLocaleString();

            // Index step banner
            document.getElementById('indexSourceName').textContent = displayName;
            document.getElementById('indexSourceType').textContent = sourceType;
            document.getElementById('indexSourceDocs').textContent = docCount;

            // Validate step banner
            document.getElementById('validateSourceName').textContent = displayName;
            document.getElementById('validateSourceType').textContent = sourceType;

            // Status indicator for validate step
            const statusDiv = document.getElementById('validateSourceStatus');
            if (s.is_complete) {
                statusDiv.innerHTML = '<span style="color: #4ecca3; font-weight: 500;">Ready</span>';
            } else {
                statusDiv.innerHTML = '<span style="color: #f9a825; font-weight: 500;">Incomplete</span>';
            }
        }

        function populateEditForm() {
            const s = currentSource;
            document.getElementById('editName').value = s.name || '';
            document.getElementById('editDescription').value = s.description || '';
            document.getElementById('editLicense').value = s.license || 'Unknown';
            document.getElementById('editBaseUrl').value = s.base_url || '';
            document.getElementById('editLicenseVerified').checked = s.license_verified || false;

            // Populate rename form (admin only)
            document.getElementById('renameCurrentId').value = s.source_id || '';
            document.getElementById('renameNewId').value = '';

            // Show base URL section if already configured
            if (s.base_url) {
                document.getElementById('detectedUrlSection').style.display = 'block';
                document.getElementById('urlPreview').innerHTML = 'Existing base URL loaded. Test or update as needed.';
            }
        }

        function populateTagsForm() {
            const s = currentSource;
            // Tags - convert array to comma-separated string
            const tags = Array.isArray(s.tags) ? s.tags.join(', ') : (s.tags || '');
            document.getElementById('editTags').value = tags;

            // Hide suggested tags hint initially
            document.getElementById('suggestedTagsHint').style.display = 'none';
        }

        // Save source configuration (Step 2 - without tags)
        async function saveSourceConfig() {
            if (!currentSource) return;

            const config = {
                source_id: currentSource.source_id,
                name: document.getElementById('editName').value,
                description: document.getElementById('editDescription').value,
                license: document.getElementById('editLicense').value,
                license_verified: document.getElementById('editLicenseVerified').checked
            };
            // Note: base_url is now configured in Step 3

            logOutput(`Saving configuration for ${currentSource.source_id}...`);

            try {
                const response = await fetch('/useradmin/api/update-source-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const data = await response.json();

                if (response.ok) {
                    logOutput('Configuration saved successfully', 'success');
                    showToast('Configuration saved');
                    await refreshSources();
                    await loadSourceDetails();
                } else {
                    logOutput(`Error: ${data.detail || 'Save failed'}`, 'error');
                    showToast(data.detail || 'Save failed', true);
                }
            } catch (e) {
                logOutput(`Error: ${e.message}`, 'error');
                showToast('Error: ' + e.message, true);
            }
        }

        // Store sample articles for URL pattern detection
        let urlSamples = [];

        // Load sample articles for URL pattern detection
        async function loadUrlSamples() {
            if (!currentSource) {
                showToast('No source selected', true);
                return;
            }

            const statusSpan = document.getElementById('urlSamplesStatus');

            // Check if we already have pre-fetched samples from Auto-detect
            if (urlSamples.length > 0) {
                statusSpan.textContent = '';
                displayUrlSamples(urlSamples);
                logOutput(`Using ${urlSamples.length} pre-loaded sample articles`);
                return;
            }

            statusSpan.textContent = 'Loading...';
            statusSpan.style.color = '#888';

            try {
                // Try the new ZIM samples endpoint first (no metadata required)
                const response = await fetch(`/useradmin/api/zim/samples/${currentSource.source_id}?count=20`);
                const data = await response.json();

                if (response.ok && data.samples && data.samples.length > 0) {
                    // Convert to expected format
                    urlSamples = data.samples.map(s => ({
                        title: s.title,
                        article_name: s.article_name,
                        zim_path: s.zim_path
                    }));
                    statusSpan.textContent = '';
                    displayUrlSamples(urlSamples);
                    logOutput(`Loaded ${urlSamples.length} sample articles from ZIM`);
                    return;
                }

                // Fallback to metadata-based endpoint for non-ZIM sources
                const metaResponse = await fetch(`/useradmin/api/test-links/${currentSource.source_id}`);
                const metaData = await metaResponse.json();

                if (metaData.error) {
                    statusSpan.textContent = 'Error';
                    statusSpan.style.color = '#e94560';
                    showToast(metaData.error, true);
                    return;
                }

                if (!metaData.sample_links || metaData.sample_links.length === 0) {
                    statusSpan.textContent = 'No samples';
                    statusSpan.style.color = '#f9a825';
                    showToast('No sample articles found', true);
                    return;
                }

                urlSamples = metaData.sample_links;
                statusSpan.textContent = '';
                displayUrlSamples(urlSamples);
                logOutput(`Loaded ${urlSamples.length} sample articles for URL detection`);

            } catch (e) {
                statusSpan.textContent = 'Error';
                statusSpan.style.color = '#e94560';
                showToast('Error: ' + e.message, true);
            }
        }

        // Display sample articles in the URL detection table
        function displayUrlSamples(samples) {
            const tbody = document.getElementById('urlSamplesBody');
            tbody.innerHTML = '';

            samples.forEach((link, i) => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #222';
                row.innerHTML = `
                    <td style="padding: 0.5rem; max-width: 150px; overflow: hidden; text-overflow: ellipsis;" title="${link.title}">${link.title}</td>
                    <td style="padding: 0.5rem; font-family: monospace; color: #4ecca3; font-size: 0.8rem;" title="${link.article_name}">${link.article_name || '(unknown)'}</td>
                    <td style="padding: 0.5rem;">
                        <input type="text" class="actual-url-input" data-index="${i}" data-article="${link.article_name}"
                               placeholder="https://..." style="width: 100%; font-size: 0.8rem; font-family: monospace;">
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('urlSamplesTable').style.display = 'block';
        }

        // Detect URL pattern from user-provided actual URLs
        function detectUrlPattern() {
            const inputs = document.querySelectorAll('.actual-url-input');
            let detectedBase = null;
            let matchCount = 0;

            inputs.forEach(input => {
                const actualUrl = input.value.trim();
                const articleName = input.dataset.article;

                if (actualUrl && articleName) {
                    // Find where the article name appears in the actual URL
                    const articleIndex = actualUrl.indexOf(articleName);

                    if (articleIndex > 0) {
                        // Extract everything before the article name as the base URL
                        const candidateBase = actualUrl.substring(0, articleIndex);

                        if (candidateBase.startsWith('http://') || candidateBase.startsWith('https://')) {
                            if (!detectedBase) {
                                detectedBase = candidateBase;
                                matchCount = 1;
                            } else if (candidateBase === detectedBase) {
                                matchCount++;
                            }
                        }
                    }
                }
            });

            if (detectedBase) {
                // Show the detected base URL
                document.getElementById('editBaseUrl').value = detectedBase;
                document.getElementById('detectedUrlSection').style.display = 'block';

                // Show preview
                const previewDiv = document.getElementById('urlPreview');
                if (urlSamples.length > 0) {
                    const sample = urlSamples[0];
                    previewDiv.innerHTML = `Example: <code style="color: #4ecca3;">${detectedBase}${sample.article_name}</code>`;
                }

                logOutput(`Detected base URL from ${matchCount} sample(s): ${detectedBase}`, 'success');
                showToast('Pattern detected! Review and save.');
            } else {
                showToast('Could not detect pattern. Make sure URLs contain the article name.', true);
                logOutput('Pattern detection failed. Ensure pasted URLs contain the exact article name.', 'warning');
            }
        }

        // Show manual base URL entry
        function showManualBaseUrl() {
            document.getElementById('detectedUrlSection').style.display = 'block';
            document.getElementById('editBaseUrl').focus();

            // Show preview if we have samples
            const previewDiv = document.getElementById('urlPreview');
            if (urlSamples.length > 0) {
                const sample = urlSamples[0];
                previewDiv.innerHTML = `Article name: <code style="color: #888;">${sample.article_name}</code> - enter the URL prefix before it`;
            } else {
                previewDiv.innerHTML = 'Load samples first to see article names, or enter URL directly.';
            }
        }

        // Update preview when base URL changes
        function updateUrlPreview() {
            const baseUrl = document.getElementById('editBaseUrl').value.trim();
            const previewDiv = document.getElementById('urlPreview');

            if (urlSamples.length > 0 && baseUrl) {
                const sample = urlSamples[0];
                const fullUrl = baseUrl.endsWith('/') ? baseUrl + sample.article_name : baseUrl + '/' + sample.article_name;
                previewDiv.innerHTML = `Preview: <a href="${fullUrl}" target="_blank" style="color: #4ecca3;">${fullUrl}</a>`;
            }
        }

        // Test base URL with sample articles (Step 3)
        async function testBaseUrl() {
            if (!currentSource) {
                showToast('No source selected', true);
                return;
            }

            const baseUrl = document.getElementById('editBaseUrl').value.trim();
            const statusSpan = document.getElementById('testUrlStatus');
            const resultsDiv = document.getElementById('testUrlResults');

            if (!baseUrl) {
                showToast('Enter a base URL to test', true);
                return;
            }

            statusSpan.textContent = 'Testing...';
            statusSpan.style.color = '#888';
            resultsDiv.style.display = 'none';

            try {
                const response = await fetch(`/useradmin/api/test-links/${currentSource.source_id}?test_base_url=${encodeURIComponent(baseUrl)}`);
                const data = await response.json();

                if (data.error) {
                    statusSpan.textContent = 'Error';
                    statusSpan.style.color = '#e94560';
                    resultsDiv.style.display = 'block';
                    resultsDiv.innerHTML = `<div style="color: #e94560;">${data.error}</div>`;
                    return;
                }

                if (!data.sample_links || data.sample_links.length === 0) {
                    statusSpan.textContent = 'No metadata';
                    statusSpan.style.color = '#f9a825';
                    resultsDiv.style.display = 'block';
                    resultsDiv.innerHTML = '<div style="color: #f9a825;">No sample articles found. Run "Generate Metadata" above first, then test your base URL.</div>';
                    return;
                }

                // Build results
                let html = '<div style="margin-bottom: 0.5rem;"><strong>Sample URLs with this base:</strong></div>';
                html += '<table style="width: 100%; border-collapse: collapse;">';
                html += '<tr style="border-bottom: 1px solid #333;"><th style="text-align: left; padding: 0.25rem;">Title</th><th style="text-align: left; padding: 0.25rem;">Constructed URL</th><th style="text-align: left; padding: 0.25rem;">Test</th></tr>';

                data.sample_links.forEach(link => {
                    const testUrl = link.constructed_url;
                    const displayUrl = testUrl.length > 50 ? testUrl.substring(0, 47) + '...' : testUrl;

                    html += `<tr style="border-bottom: 1px solid #222;">
                        <td style="padding: 0.25rem; max-width: 150px; overflow: hidden; text-overflow: ellipsis;">${link.title}</td>
                        <td style="padding: 0.25rem; font-family: monospace; font-size: 0.8rem; color: #4ecca3;" title="${testUrl}">${displayUrl}</td>
                        <td style="padding: 0.25rem;">
                            <a href="${testUrl}" target="_blank" style="color: #4ecca3;">Open</a>
                        </td>
                    </tr>`;
                });

                html += '</table>';
                html += '<div style="margin-top: 0.5rem; color: #888; font-size: 0.8rem;">Click "Open" to verify links work before saving.</div>';

                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = html;
                statusSpan.textContent = 'Done';
                statusSpan.style.color = '#4ecca3';

            } catch (e) {
                statusSpan.textContent = 'Error';
                statusSpan.style.color = '#e94560';
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = `<div style="color: #e94560;">Error: ${e.message}</div>`;
            }
        }

        // Save just the base URL (Step 3)
        async function saveBaseUrl() {
            if (!currentSource) {
                showToast('No source selected', true);
                return;
            }

            const baseUrl = document.getElementById('editBaseUrl').value.trim();
            const statusSpan = document.getElementById('testUrlStatus');

            statusSpan.textContent = 'Saving...';
            statusSpan.style.color = '#888';

            try {
                const response = await fetch('/useradmin/api/update-source-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source_id: currentSource.source_id,
                        base_url: baseUrl
                    })
                });

                if (response.ok) {
                    statusSpan.textContent = 'Saved!';
                    statusSpan.style.color = '#4ecca3';
                    showToast('Base URL saved');
                    logOutput(`Base URL saved: ${baseUrl || '(empty)'}`, 'success');
                    if (baseUrl) {
                        markSectionComplete('sectionBaseUrl');
                    } else {
                        markSectionSkipped('sectionBaseUrl');
                    }
                    // Refresh source details
                    await refreshSources();
                    await loadSourceDetails();
                } else {
                    const data = await response.json();
                    statusSpan.textContent = 'Error';
                    statusSpan.style.color = '#e94560';
                    showToast(data.detail || 'Save failed', true);
                }
            } catch (e) {
                statusSpan.textContent = 'Error';
                statusSpan.style.color = '#e94560';
                showToast('Error: ' + e.message, true);
            }
        }

        async function autoDetect() {
            if (!currentSource) return;

            logOutput(`Auto-detecting metadata for ${currentSource.source_id}...`);

            try {
                const response = await fetch(`/useradmin/api/auto-detect/${currentSource.source_id}`);
                const data = await response.json();

                if (response.ok) {
                    let detectedCount = 0;

                    // Detected name
                    if (data.detected_name) {
                        document.getElementById('editName').value = data.detected_name;
                        logOutput(`Detected name: ${data.detected_name}`, 'success');
                        detectedCount++;
                    }

                    // Detected description
                    if (data.detected_description) {
                        document.getElementById('editDescription').value = data.detected_description;
                        logOutput(`Detected description: ${data.detected_description.substring(0, 100)}...`, 'success');
                        detectedCount++;
                    }

                    // Detected license
                    if (data.detected_license && data.detected_license !== 'Unknown') {
                        document.getElementById('editLicense').value = data.detected_license;
                        logOutput(`Detected license: ${data.detected_license}`, 'success');
                        detectedCount++;
                    } else {
                        logOutput('Could not auto-detect license', 'warning');
                    }

                    // Detected base URL
                    if (data.base_url) {
                        document.getElementById('editBaseUrl').value = data.base_url;
                        logOutput(`Detected base URL: ${data.base_url}`, 'success');
                        detectedCount++;
                    }

                    // Suggested tags
                    if (data.suggested_tags && data.suggested_tags.length > 0) {
                        logOutput(`Suggested tags: ${data.suggested_tags.join(', ')}`, 'info');
                    }

                    // Source type info
                    if (data.source_type) {
                        logOutput(`Source type: ${data.source_type.toUpperCase()}`, 'info');
                    }

                    // ZIM-specific metadata
                    if (data.zim_metadata) {
                        const zm = data.zim_metadata;
                        if (zm.creator) logOutput(`  Creator: ${zm.creator}`, 'info');
                        if (zm.publisher) logOutput(`  Publisher: ${zm.publisher}`, 'info');
                        if (zm.language) logOutput(`  Language: ${zm.language}`, 'info');
                        if (zm.date) logOutput(`  Date: ${zm.date}`, 'info');
                        if (zm.article_count) logOutput(`  Articles: ${zm.article_count.toLocaleString()}`, 'info');
                    }

                    if (detectedCount > 0) {
                        showToast(`Auto-detected ${detectedCount} field(s)`);
                    } else {
                        showToast('No metadata could be auto-detected', true);
                    }

                    // For ZIM sources, also fetch sample articles for URL detection in Step 3
                    if (data.source_type === 'zim') {
                        fetchZimSamples();
                    }
                } else {
                    logOutput(`Error: ${data.detail || 'Auto-detect failed'}`, 'error');
                }
            } catch (e) {
                logOutput(`Error: ${e.message}`, 'error');
            }
        }

        // Fetch ZIM sample articles directly (no metadata required)
        async function fetchZimSamples() {
            if (!currentSource) return;

            try {
                const response = await fetch(`/useradmin/api/zim/samples/${currentSource.source_id}?count=20`);
                const data = await response.json();

                if (response.ok && data.samples && data.samples.length > 0) {
                    // Convert to the format expected by URL detection
                    urlSamples = data.samples.map(s => ({
                        title: s.title,
                        article_name: s.article_name,
                        zim_path: s.zim_path
                    }));
                    logOutput(`Loaded ${urlSamples.length} sample articles for URL detection (Step 3)`, 'info');
                }
            } catch (e) {
                // Silent fail - samples are optional for URL detection
                console.log('Could not fetch ZIM samples:', e);
            }
        }

        // Indexing functions
        async function scanBackup() {
            if (!currentSource) return;

            const btn = document.getElementById('btnScanBackup');
            btn.disabled = true;
            btn.textContent = 'Scanning...';

            logOutput(`Scanning backup for ${currentSource.source_id}...`);

            try {
                const response = await fetch('/useradmin/api/scan-backup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source_id: currentSource.source_id })
                });

                const data = await response.json();

                if (response.ok) {
                    logOutput(`Scan complete: ${data.file_count || 0} files found`, 'success');
                    showToast('Backup scanned successfully');
                    markSectionComplete('scanBackupSection');
                    await refreshSources();
                    await loadSourceDetails();
                } else {
                    logOutput(`Error: ${data.detail || 'Scan failed'}`, 'error');
                    showToast(data.detail || 'Scan failed', true);
                }
            } catch (e) {
                logOutput(`Error: ${e.message}`, 'error');
                showToast('Error: ' + e.message, true);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Scan Backup';
            }
        }

        // Checkpoint modal state
        let pendingCheckpointJobType = null;
        let pendingCheckpointSourceId = null;

        function showCheckpointModal(checkpoint, jobType) {
            pendingCheckpointJobType = jobType;
            pendingCheckpointSourceId = checkpoint.source_id;

            document.getElementById('checkpointJobType').textContent = jobType;
            document.getElementById('checkpointSourceId').textContent = checkpoint.source_id;
            document.getElementById('checkpointProgress').textContent = checkpoint.progress + '%';
            document.getElementById('checkpointDocsProcessed').textContent = (checkpoint.documents_processed || 0).toLocaleString();

            // Format last saved time
            if (checkpoint.last_saved) {
                const savedDate = new Date(checkpoint.last_saved);
                const now = new Date();
                const hoursAgo = Math.floor((now - savedDate) / (1000 * 60 * 60));
                if (hoursAgo < 1) {
                    document.getElementById('checkpointLastSaved').textContent = 'Less than an hour ago';
                } else if (hoursAgo < 24) {
                    document.getElementById('checkpointLastSaved').textContent = hoursAgo + ' hours ago';
                } else {
                    document.getElementById('checkpointLastSaved').textContent = Math.floor(hoursAgo / 24) + ' days ago';
                }
            } else {
                document.getElementById('checkpointLastSaved').textContent = 'Unknown';
            }

            document.getElementById('resumeCheckpointModal').style.display = 'flex';
        }

        function closeCheckpointModal() {
            document.getElementById('resumeCheckpointModal').style.display = 'none';
            pendingCheckpointJobType = null;
            pendingCheckpointSourceId = null;

            // Re-enable button
            const btn = document.getElementById('btnGenerateMetadata');
            if (btn) {
                btn.disabled = false;
                btn.textContent = 'Generate Metadata';
            }
        }

        async function proceedWithCheckpoint(action) {
            closeCheckpointModal();

            if (action === 'restart') {
                // Discard checkpoint and start fresh
                try {
                    await fetch(`/useradmin/api/discard-checkpoint/${pendingCheckpointSourceId}/${pendingCheckpointJobType}`, {
                        method: 'POST'
                    });
                    logOutput('Discarded old checkpoint, starting fresh...', 'info');
                } catch (e) {
                    logOutput('Warning: Could not discard checkpoint: ' + e.message, 'warning');
                }
                // Start fresh
                startMetadataGeneration(false);
            } else if (action === 'resume') {
                // Resume from checkpoint
                logOutput('Resuming from checkpoint...', 'info');
                startMetadataGeneration(true);
            }
        }

        async function generateMetadata() {
            if (!currentSource) return;

            const btn = document.getElementById('btnGenerateMetadata');
            btn.disabled = true;
            btn.textContent = 'Checking...';

            // Check for existing checkpoint first
            try {
                const checkResp = await fetch(`/useradmin/api/check-checkpoint/${currentSource.source_id}/metadata`);
                const checkData = await checkResp.json();

                if (checkData.has_checkpoint) {
                    // Show modal to ask user what to do
                    showCheckpointModal(checkData.checkpoint, 'metadata');
                    return;
                }
            } catch (e) {
                // Checkpoint system not available, proceed normally
                console.log('Checkpoint check failed:', e);
            }

            // No checkpoint, start fresh
            startMetadataGeneration(false);
        }

        async function startMetadataGeneration(resume = false) {
            const btn = document.getElementById('btnGenerateMetadata');
            btn.disabled = true;
            btn.textContent = 'Starting...';

            const languageFilter = document.getElementById('metadataLanguageFilter').value || null;
            const langInfo = languageFilter ? ` (language: ${languageFilter})` : '';
            const resumeInfo = resume ? ' (resuming)' : '';
            logOutput(`Generating metadata for ${currentSource.source_id}${langInfo}${resumeInfo}...`);

            try {
                const requestBody = {
                    source_id: currentSource.source_id,
                    resume: resume
                };
                if (languageFilter) {
                    requestBody.language_filter = languageFilter;
                }

                const response = await fetch('/useradmin/api/generate-metadata', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (!response.ok) {
                    logOutput(`Error: ${data.detail || 'Failed to start'}`, 'error');
                    showToast(data.detail || 'Failed to start', true);
                    btn.disabled = false;
                    btn.textContent = 'Generate Metadata';
                    return;
                }

                // Job submitted - poll for completion
                const jobId = data.job_id;
                logOutput(`Job submitted: ${jobId}`, 'info');
                btn.textContent = 'Processing...';

                const pollInterval = 1500;
                const maxAttempts = 120; // 3 minutes max
                let attempts = 0;

                const pollForCompletion = async () => {
                    attempts++;
                    try {
                        const statusResp = await fetch(`/useradmin/api/jobs/${jobId}`);
                        const status = await statusResp.json();

                        if (status.status === 'completed') {
                            if (status.result && status.result.status === 'success') {
                                const docCount = status.result.document_count || 0;
                                logOutput(`Metadata generated: ${docCount} documents`, 'success');
                                showToast('Metadata generated successfully');
                                markSectionComplete('sectionGenerateMetadata');
                                updateDocumentCount(docCount);
                                await refreshSources();
                                await loadSourceDetails();
                            } else {
                                const errMsg = status.result?.error || 'Generation failed';
                                logOutput(`Error: ${errMsg}`, 'error');
                                showToast(errMsg, true);
                            }
                            btn.disabled = false;
                            btn.textContent = 'Generate Metadata';
                            return;
                        } else if (status.status === 'failed') {
                            logOutput(`Error: ${status.error || 'Job failed'}`, 'error');
                            showToast('Metadata generation failed', true);
                            btn.disabled = false;
                            btn.textContent = 'Generate Metadata';
                            return;
                        } else if (attempts >= maxAttempts) {
                            logOutput('Timeout waiting for job to complete', 'error');
                            showToast('Job timeout', true);
                            btn.disabled = false;
                            btn.textContent = 'Generate Metadata';
                            return;
                        }

                        if (status.progress) {
                            btn.textContent = `Processing... ${status.progress}%`;
                        }

                        setTimeout(pollForCompletion, pollInterval);
                    } catch (pollErr) {
                        logOutput(`Error polling job status: ${pollErr.message}`, 'error');
                        btn.disabled = false;
                        btn.textContent = 'Generate Metadata';
                    }
                };

                setTimeout(pollForCompletion, pollInterval);

            } catch (e) {
                logOutput(`Error: ${e.message}`, 'error');
                showToast('Error: ' + e.message, true);
                btn.disabled = false;
                btn.textContent = 'Generate Metadata';
            }
        }

        function updateDocumentCount(count) {
            // Update the document count display in the embeddings section
            const countDisplay = document.getElementById('documentCountDisplay');
            if (countDisplay) {
                countDisplay.textContent = `Source contains ${count.toLocaleString()} documents`;
                countDisplay.style.display = 'block';
            }
            // Also update the "Index All" button
            const indexAllBtn = document.getElementById('btnIndexAll');
            if (indexAllBtn && count > 0) {
                indexAllBtn.textContent = `Index All (${count.toLocaleString()})`;
                indexAllBtn.style.display = 'inline-block';
                indexAllBtn.dataset.docCount = count;
            }
        }

        function indexAll() {
            // Get the document count from the button's data attribute
            const indexAllBtn = document.getElementById('btnIndexAll');
            const docCount = parseInt(indexAllBtn?.dataset.docCount) || 0;
            if (docCount > 0) {
                // Set the limit input to the total count
                document.getElementById('indexLimit').value = docCount;
                // Run the index
                createIndex(false);
            }
        }

        async function createIndex(forceReindex = false) {
            if (!currentSource) return;

            const limit = parseInt(document.getElementById('indexLimit').value) || 1000;
            const languageFilter = document.getElementById('metadataLanguageFilter').value || null;

            const btn = document.getElementById('btnCreateIndex');
            btn.disabled = true;
            btn.textContent = 'Checking...';

            // If force reindex, skip the check and go straight to replace mode
            if (forceReindex) {
                await doCreateIndex(true);
                return;
            }

            try {
                // Check if source already has vectors locally
                const checkResponse = await fetch(`/useradmin/api/local-source-check/${currentSource.source_id}`);
                const checkData = await checkResponse.json();

                if (checkData.exists && checkData.vector_count > 0) {
                    // Source has existing vectors - show modal to choose update or replace
                    pendingIndexLimit = limit;
                    pendingIndexLanguageFilter = languageFilter;

                    document.getElementById('indexModalSourceId').textContent = currentSource.source_id;
                    document.getElementById('indexModalVectorCount').textContent = checkData.vector_count.toLocaleString();
                    document.getElementById('indexSyncModal').classList.add('show');
                    btn.disabled = false;
                    btn.textContent = 'Create Index';
                    return;
                }

                // No existing vectors - proceed with normal index (update mode)
                await doCreateIndex(false);
            } catch (e) {
                logOutput(`Error checking existing index: ${e.message}`, 'error');
                // Fall back to normal index if check fails
                await doCreateIndex(false);
            }
        }

        function closeIndexModal() {
            document.getElementById('indexSyncModal').classList.remove('show');
        }

        async function proceedWithIndex(mode) {
            console.log('proceedWithIndex called with mode:', mode);
            document.getElementById('indexSyncModal').classList.remove('show');
            // mode: 'update' = skip existing, 'replace' = force reindex
            try {
                await doCreateIndex(mode === 'replace');
            } catch (e) {
                console.error('proceedWithIndex error:', e);
                showToast('Error: ' + e.message, true);
            }
        }

        async function doCreateIndex(forceReindex) {
            if (!currentSource) {
                console.error('doCreateIndex: No source selected');
                showToast('No source selected', true);
                return;
            }

            const limit = pendingIndexLimit || parseInt(document.getElementById('indexLimit').value) || 1000;
            const languageFilter = pendingIndexLanguageFilter || document.getElementById('metadataLanguageFilter').value || null;

            // Reset pending state after reading
            pendingIndexLimit = null;
            pendingIndexLanguageFilter = null;

            const btn = document.getElementById('btnCreateIndex');
            if (!btn) {
                console.error('doCreateIndex: Button not found');
                return;
            }
            btn.disabled = true;
            btn.textContent = forceReindex ? 'Replacing...' : 'Starting...';

            const langInfo = languageFilter ? ` (language: ${languageFilter})` : '';
            const modeInfo = forceReindex ? ' [REPLACE]' : ' [UPDATE]';
            logOutput(`Creating embeddings for ${currentSource.source_id} (limit: ${limit})${langInfo}${modeInfo}...`);

            try {
                const requestBody = {
                    source_id: currentSource.source_id,
                    limit: limit,
                    force_reindex: forceReindex
                };
                if (languageFilter) {
                    requestBody.language_filter = languageFilter;
                }

                const response = await fetch('/useradmin/api/create-index', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.status === 'submitted' || data.job_id) {
                        logOutput(`Job submitted: ${data.job_id}`, 'success');
                        logOutput('Index creation running in background. Check the job monitor for progress.', 'info');
                        showToast('Index job started');
                        // Mark as complete - job is running and will update source
                        markSectionComplete('sectionCreateIndex');
                    } else {
                        logOutput(`Index complete: ${data.indexed_count || 0} documents indexed`, 'success');
                        showToast('Index created successfully');
                        markSectionComplete('sectionCreateIndex');
                    }
                    await refreshSources();
                    await loadSourceDetails();
                } else if (response.status === 409) {
                    logOutput('A job is already running for this source', 'warning');
                    showToast('Job already running', true);
                } else {
                    logOutput(`Error: ${data.detail || 'Index creation failed'}`, 'error');
                    showToast(data.detail || 'Index creation failed', true);
                }
            } catch (e) {
                logOutput(`Error: ${e.message}`, 'error');
                showToast('Error: ' + e.message, true);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Index';
            }
        }

        async function validateSource() {
            if (!currentSource) return;

            logOutput(`Validating ${currentSource.source_id}...`);

            try {
                const response = await fetch('/useradmin/api/validate-source', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source_id: currentSource.source_id })
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.is_valid) {
                        logOutput('Validation passed! Source is ready for distribution.', 'success');
                        markSectionComplete('sectionValidate');
                        // Show success banner with link to Cloud page
                        showValidationSuccess();
                        // Hide issues panel
                        document.getElementById('validationIssuesPanel').style.display = 'none';
                    } else {
                        logOutput('Validation failed. Issues found:', 'warning');
                        if (data.issues) {
                            data.issues.forEach(issue => logOutput(`  - ${issue}`, 'error'));
                        }
                        // Show actionable issues panel
                        showActionableIssues(data.actionable_issues || [], data.issues || [], data.warnings || []);
                    }

                    if (data.warnings && data.warnings.length > 0) {
                        logOutput('Warnings:', 'warning');
                        data.warnings.forEach(w => logOutput(`  - ${w}`, 'warning'));
                    }

                    if (data.suggested_tags && data.suggested_tags.length > 0) {
                        logOutput(`Suggested tags: ${data.suggested_tags.join(', ')}`, 'info');
                        // Store suggested tags and show hint in Configure step
                        window.suggestedTags = data.suggested_tags;
                        document.getElementById('suggestedTagsList').textContent = data.suggested_tags.join(', ');
                        document.getElementById('suggestedTagsHint').style.display = 'block';
                    }

                    showToast(data.is_valid ? 'Validation passed' : 'Validation failed', !data.is_valid);
                } else {
                    logOutput(`Error: ${data.detail || 'Validation failed'}`, 'error');
                    showToast(data.detail || 'Validation failed', true);
                }
            } catch (e) {
                logOutput(`Error: ${e.message}`, 'error');
                showToast('Error: ' + e.message, true);
            }
        }

        // Display actionable issues with fix buttons
        function showActionableIssues(actionableIssues, issues, warnings) {
            const panel = document.getElementById('validationIssuesPanel');
            const container = document.getElementById('validationIssuesList');

            if (!actionableIssues || actionableIssues.length === 0) {
                // Fall back to plain issues/warnings display
                if (issues.length === 0 && warnings.length === 0) {
                    panel.style.display = 'none';
                    return;
                }
                let html = '';
                issues.forEach(issue => {
                    html += `<div class="validation-issue error"><span class="issue-text">${issue}</span></div>`;
                });
                warnings.forEach(warning => {
                    html += `<div class="validation-issue warning"><span class="issue-text">${warning}</span></div>`;
                });
                container.innerHTML = html;
                panel.style.display = 'block';
                return;
            }

            // Group issues by step for organized display
            const byStep = {};
            actionableIssues.forEach(issue => {
                const step = issue.step || 0;
                if (!byStep[step]) byStep[step] = [];
                byStep[step].push(issue);
            });

            const stepNames = {
                1: 'Step 1: Create/Import',
                2: 'Step 2: Configure',
                3: 'Step 3: Generate Metadata',
                4: 'Step 4: Tags',
                5: 'Step 5: Index & Validate'
            };

            let html = '';
            Object.keys(byStep).sort((a, b) => a - b).forEach(step => {
                const stepIssues = byStep[step];
                if (step > 0) {
                    html += `<div class="validation-step-group"><strong>${stepNames[step] || 'Step ' + step}</strong></div>`;
                }
                stepIssues.forEach(issue => {
                    const severityClass = issue.severity === 'error' ? 'error' : 'warning';
                    const fixBtn = issue.action_label && issue.step > 0
                        ? `<button class="btn btn-sm" onclick="goToStep(${issue.step})">${issue.action_label}</button>`
                        : '';
                    html += `
                        <div class="validation-issue ${severityClass}">
                            <span class="issue-text">${issue.message}</span>
                            ${fixBtn}
                        </div>
                    `;
                });
            });

            container.innerHTML = html;
            panel.style.display = 'block';
        }

        async function testLinks() {
            if (!currentSource) {
                showToast('No source selected', true);
                return;
            }

            const resultsDiv = document.getElementById('testLinksResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<div style="color: #888;">Testing links...</div>';
            logOutput(`Testing links for ${currentSource.source_id}...`);

            try {
                const response = await fetch(`/useradmin/api/test-links/${currentSource.source_id}`);
                const data = await response.json();

                if (data.error) {
                    resultsDiv.innerHTML = `<div style="color: #e94560;">Error: ${data.error}</div>`;
                    logOutput(`Error: ${data.error}`, 'error');
                    return;
                }

                // Build results HTML
                let html = `<div style="margin-bottom: 0.5rem;">
                    <strong>Base URL:</strong> ${data.base_url || '(not set)'}
                </div>`;

                if (data.warning) {
                    html += `<div style="color: #f9a825; margin-bottom: 0.5rem;">
                        Warning: ${data.warning}
                    </div>`;
                    logOutput(`Warning: ${data.warning}`, 'warning');
                }

                if (data.sample_links && data.sample_links.length > 0) {
                    html += '<table style="width: 100%; border-collapse: collapse; margin-top: 0.5rem;">';
                    html += '<tr style="border-bottom: 1px solid #333;"><th style="text-align: left; padding: 0.25rem;">Title</th><th style="text-align: left; padding: 0.25rem;">URL Type</th><th style="text-align: left; padding: 0.25rem;">Test</th></tr>';

                    data.sample_links.forEach(link => {
                        const typeColor = link.is_online_url ? '#4ecca3' : '#e94560';
                        const typeLabel = link.is_online_url ? 'Online' : (link.is_local_url ? 'Local' : 'Unknown');
                        const displayUrl = link.constructed_url || link.stored_url;
                        const testUrl = link.is_online_url ? displayUrl : null;

                        html += `<tr style="border-bottom: 1px solid #222;">
                            <td style="padding: 0.25rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${link.title}</td>
                            <td style="padding: 0.25rem; color: ${typeColor};">${typeLabel}</td>
                            <td style="padding: 0.25rem;">
                                ${testUrl ? `<a href="${testUrl}" target="_blank" style="color: #4ecca3;">Open</a>` : '<span style="color: #666;">N/A</span>'}
                            </td>
                        </tr>`;

                        logOutput(`  ${link.title}: ${typeLabel} - ${displayUrl}`);
                    });

                    html += '</table>';
                } else {
                    html += '<div style="color: #888;">No sample links found. Generate metadata first.</div>';
                }

                resultsDiv.innerHTML = html;

                // Summary
                const onlineCount = data.sample_links.filter(l => l.is_online_url).length;
                const totalCount = data.sample_links.length;
                if (onlineCount === totalCount && totalCount > 0) {
                    logOutput(`All ${totalCount} sample links are online URLs - ready for Pinecone!`, 'success');
                    showToast('Links look good!');
                    markSectionComplete('sectionTestLinks');
                } else if (totalCount > 0) {
                    logOutput(`${onlineCount}/${totalCount} links are online. Re-index may be needed.`, 'warning');
                    showToast(`${totalCount - onlineCount} links are local - may not work on Railway`, true);
                } else {
                    // No links to test, mark as skipped
                    markSectionSkipped('sectionTestLinks');
                }

            } catch (e) {
                resultsDiv.innerHTML = `<div style="color: #e94560;">Error: ${e.message}</div>`;
                logOutput(`Error: ${e.message}`, 'error');
                showToast('Error: ' + e.message, true);
            }
        }

        function showValidationSuccess() {
            // Show success banner with button to go to Cloud page
            let banner = document.getElementById('validationSuccessBanner');
            if (!banner) {
                banner = document.createElement('div');
                banner.id = 'validationSuccessBanner';
                banner.style.cssText = 'background: #1a3a2a; border: 1px solid #4ecca3; border-radius: 6px; padding: 1rem; margin-top: 1rem; display: flex; align-items: center; justify-content: space-between; gap: 1rem;';
                banner.innerHTML = `
                    <div>
                        <div style="color: #4ecca3; font-weight: 600;">Validation Successful!</div>
                        <div style="color: #888; font-size: 0.85rem;">Source is ready for cloud upload</div>
                    </div>
                    <a href="/useradmin/cloud" class="btn btn-primary" style="text-decoration: none;">
                        Go to Cloud Page
                    </a>
                `;
                // Insert after the output log
                const outputLog = document.getElementById('outputLog');
                if (outputLog && outputLog.parentNode) {
                    outputLog.parentNode.insertBefore(banner, outputLog.nextSibling);
                }
            }
            banner.style.display = 'flex';
        }

        function applySuggestedTags() {
            if (window.suggestedTags && window.suggestedTags.length > 0) {
                document.getElementById('editTags').value = window.suggestedTags.join(', ');
                logOutput('Applied suggested tags', 'success');
                showToast('Tags applied - click Save Tags to confirm');
            }
        }

        // Save tags (Step 4)
        async function saveTags() {
            if (!currentSource) return;

            const tagsStr = document.getElementById('editTags').value;
            const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t) : [];

            const config = {
                source_id: currentSource.source_id,
                tags: tags
            };

            logOutput(`Saving tags for ${currentSource.source_id}...`);

            try {
                const response = await fetch('/useradmin/api/update-source-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const data = await response.json();

                if (response.ok) {
                    logOutput(`Tags saved: ${tags.join(', ') || '(none)'}`, 'success');
                    showToast('Tags saved');
                    markSectionComplete('sectionTags');
                    await refreshSources();
                    await loadSourceDetails();
                } else {
                    logOutput(`Error: ${data.detail || 'Save failed'}`, 'error');
                    showToast(data.detail || 'Save failed', true);
                }
            } catch (e) {
                logOutput(`Error: ${e.message}`, 'error');
                showToast('Error: ' + e.message, true);
            }
        }

        // Get suggested tags by running validation
        async function getSuggestedTags() {
            if (!currentSource) return;

            logOutput(`Analyzing content for tag suggestions...`);

            try {
                const response = await fetch('/useradmin/api/validate-source', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source_id: currentSource.source_id })
                });

                const data = await response.json();

                if (response.ok && data.suggested_tags && data.suggested_tags.length > 0) {
                    // New suggestions available - populate text box
                    window.suggestedTags = data.suggested_tags;
                    document.getElementById('editTags').value = data.suggested_tags.join(', ');
                    document.getElementById('suggestedTagsList').textContent = data.suggested_tags.join(', ');
                    document.getElementById('suggestedTagsHint').style.display = 'block';
                    logOutput(`Suggested tags applied: ${data.suggested_tags.join(', ')}`, 'success');
                } else if (response.ok) {
                    // Check why no suggestions
                    if (data.has_tags) {
                        // Source already has tags - load them into text box
                        const existingTags = currentSource.tags || [];
                        if (existingTags.length > 0) {
                            document.getElementById('editTags').value = existingTags.join(', ');
                            logOutput(`Loaded ${existingTags.length} existing tags: ${existingTags.join(', ')}`, 'success');
                        } else {
                            logOutput('Source has tags in manifest. Edit tags below if needed.', 'info');
                        }
                    } else if (!data.has_metadata) {
                        logOutput('No tag suggestions - source needs to be indexed first (Step 3).', 'warning');
                    } else {
                        logOutput('No tag suggestions found. Try adding tags manually based on content type.', 'info');
                    }
                    document.getElementById('suggestedTagsHint').style.display = 'none';
                } else {
                    logOutput(`Validation error: ${data.detail || 'Unknown error'}`, 'error');
                    document.getElementById('suggestedTagsHint').style.display = 'none';
                }
            } catch (e) {
                logOutput(`Error: ${e.message}`, 'error');
            }
        }

        async function cleanupFiles() {
            if (!currentSource) return;

            if (!confirm('This will delete redundant legacy files if v2 files exist. Continue?')) {
                return;
            }

            logOutput(`Cleaning up redundant files for ${currentSource.source_id}...`);

            try {
                const response = await fetch('/useradmin/api/cleanup-redundant-files', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source_id: currentSource.source_id })
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.deleted && data.deleted.length > 0) {
                        logOutput(`Deleted ${data.deleted.length} file(s), freed ${data.freed_mb} MB`, 'success');
                        data.deleted.forEach(f => logOutput(`  Deleted: ${f}`, 'info'));
                    } else {
                        logOutput('No redundant files to clean up', 'info');
                    }
                    showToast(data.message || 'Cleanup complete');
                } else {
                    logOutput(`Error: ${data.detail || 'Cleanup failed'}`, 'error');
                    showToast(data.detail || 'Cleanup failed', true);
                }
            } catch (e) {
                logOutput(`Error: ${e.message}`, 'error');
                showToast('Error: ' + e.message, true);
            }
        }

        async function deleteSource() {
            if (!currentSource) return;

            const confirmMsg = `Are you sure you want to delete "${currentSource.source_id}"?\n\nThis will delete:\n- All local backup files\n- Entry from _master.json\n- All ChromaDB embeddings\n\nThis cannot be undone!`;

            if (!confirm(confirmMsg)) {
                logOutput('Delete cancelled by user', 'info');
                return;
            }

            // Double confirm
            if (!confirm('Are you REALLY sure? This is permanent!')) {
                logOutput('Delete cancelled by user', 'info');
                return;
            }

            logOutput(`Deleting ${currentSource.source_id}...`);

            try {
                const response = await fetch('/useradmin/api/delete-source', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source_id: currentSource.source_id,
                        delete_files: true
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    logOutput('Source deleted successfully', 'success');
                    if (data.deleted && data.deleted.length > 0) {
                        data.deleted.forEach(d => logOutput(`  Removed: ${d}`, 'success'));
                    }
                    if (data.freed_mb > 0) {
                        logOutput(`  Freed: ${data.freed_mb} MB`, 'success');
                    }
                    showToast(data.message || 'Source deleted');

                    // Clear selection and go back to step 1
                    document.getElementById('sourceSelect').value = '';
                    currentSource = null;
                    goToStep(1);
                    await loadSources();
                } else {
                    logOutput(`Error: ${data.detail || 'Delete failed'}`, 'error');
                    showToast(data.detail || 'Delete failed', true);
                }
            } catch (e) {
                logOutput(`Error: ${e.message}`, 'error');
                showToast('Error: ' + e.message, true);
            }
        }

        // Rename source (Admin only)
        async function renameSource() {
            if (!currentSource) return;

            const newSourceId = document.getElementById('renameNewId').value.trim();

            if (!newSourceId) {
                showToast('Please enter a new source ID', true);
                return;
            }

            if (!/^[a-z0-9][a-z0-9_-]*$/.test(newSourceId)) {
                showToast('Invalid format. Use lowercase letters, numbers, underscores, hyphens.', true);
                return;
            }

            if (newSourceId === currentSource.source_id) {
                showToast('New ID is the same as current ID', true);
                return;
            }

            const confirmMsg = `Rename "${currentSource.source_id}" to "${newSourceId}"?\n\nThis will rename:\n- Source folder\n- All config/metadata files\n- ZIM files (if present)\n- _master.json entry\n- ChromaDB documents\n\nThis cannot be easily undone!`;

            if (!confirm(confirmMsg)) {
                logOutput('Rename cancelled by user', 'info');
                return;
            }

            logOutput(`Renaming ${currentSource.source_id} to ${newSourceId}...`);

            try {
                const response = await fetch('/useradmin/api/rename-source', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        old_source_id: currentSource.source_id,
                        new_source_id: newSourceId
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    logOutput('Rename successful!', 'success');

                    if (data.renamed_files && data.renamed_files.length > 0) {
                        logOutput('  Renamed files:', 'info');
                        data.renamed_files.forEach(f => logOutput(`    ${f.old} -> ${f.new}`, 'info'));
                    }

                    if (data.updated_json && data.updated_json.length > 0) {
                        logOutput(`  Updated JSON files: ${data.updated_json.join(', ')}`, 'info');
                    }

                    if (data.master_updated) {
                        logOutput('  Updated _master.json', 'info');
                    }

                    if (data.chromadb_updated) {
                        logOutput(`  Updated ${data.chromadb_documents} ChromaDB documents`, 'info');
                    }

                    showToast(data.message || 'Source renamed successfully');

                    // Refresh and select the renamed source
                    document.getElementById('renameNewId').value = '';
                    await loadSources();
                    document.getElementById('sourceSelect').value = newSourceId;
                    await loadSourceDetails();

                } else {
                    logOutput(`Error: ${data.detail || 'Rename failed'}`, 'error');
                    showToast(data.detail || 'Rename failed', true);
                }
            } catch (e) {
                logOutput(`Error: ${e.message}`, 'error');
                showToast('Error: ' + e.message, true);
            }
        }

        // Output log
        function logOutput(message, type = '') {
            const log = document.getElementById('outputLog');
            const timestamp = new Date().toLocaleTimeString();
            const className = type ? ` class="${type}"` : '';
            log.innerHTML += `<span${className}>[${timestamp}] ${escapeHtml(message)}</span>\n`;
            log.scrollTop = log.scrollHeight;
        }

        function clearLog() {
            document.getElementById('outputLog').innerHTML = '';
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast' + (isError ? ' error' : '');
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        async function init() {
            await loadSources();

            // Check for ?source= parameter
            const urlParams = new URLSearchParams(window.location.search);
            const sourceParam = urlParams.get('source');

            if (sourceParam) {
                if (sources.find(s => s.source_id === sourceParam)) {
                    document.getElementById('sourceSelect').value = sourceParam;
                    await loadSourceDetails();

                    // Check for ?step= parameter to jump to a specific step
                    const stepParam = urlParams.get('step');
                    if (stepParam) {
                        const stepNum = parseInt(stepParam);
                        if (stepNum >= 1 && stepNum <= 5) {
                            goToStep(stepNum);
                        }
                    }
                }
            }

            updateWizardUI();
        }

        init();

        // Listen for job completions to refresh the UI
        window.addEventListener('jobComplete', (event) => {
            const job = event.detail;
            if (currentSource && job.source_id === currentSource.source_id) {
                logOutput(`Job completed: ${job.job_type} - ${job.message}`, job.status === 'completed' ? 'success' : 'error');
                loadSourceDetails();
            }
        });

    </script>

    <!-- Shared admin functionality -->
    <script src="/admin/static/admin-common.js"></script>

    <!-- Job Monitor - shows active background jobs -->
    <script src="/admin/static/job-monitor.js"></script>

    <!-- Index Sync Mode Modal -->
    <div id="indexSyncModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">Source Already Indexed</div>
            <div class="modal-body">
                <p>The source <strong id="indexModalSourceId"></strong> already has <span class="count" id="indexModalVectorCount">0</span> vectors in the local index.</p>
                <p>How would you like to proceed?</p>
                <ul style="margin: 1rem 0; padding-left: 1.5rem; color: #aaa; font-size: 0.85rem;">
                    <li><strong>Update:</strong> Add new documents, skip already-indexed ones</li>
                    <li><strong>Replace:</strong> Delete all existing vectors, then re-index from scratch</li>
                </ul>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="btnIndexCancel">Cancel</button>
                <button class="btn btn-primary" id="btnIndexUpdate">Update</button>
                <button class="btn btn-danger" id="btnIndexReplace">Replace</button>
            </div>
        </div>
    </div>

    <!-- Resume Checkpoint Modal -->
    <div id="resumeCheckpointModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">Incomplete Job Found</div>
            <div class="modal-body">
                <p>An incomplete <strong id="checkpointJobType">metadata</strong> job was found for <strong id="checkpointSourceId"></strong>.</p>
                <div style="background: #0f3460; padding: 0.75rem; border-radius: 4px; margin: 1rem 0;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="color: #888;">Progress:</span>
                        <span style="color: #4ecca3;" id="checkpointProgress">0%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="color: #888;">Documents processed:</span>
                        <span style="color: #4ecca3;" id="checkpointDocsProcessed">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #888;">Last saved:</span>
                        <span style="color: #888;" id="checkpointLastSaved">-</span>
                    </div>
                </div>
                <p>Would you like to resume from where it left off, or start over?</p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="btnCheckpointCancel">Cancel</button>
                <button class="btn btn-danger" id="btnCheckpointRestart">Start Fresh</button>
                <button class="btn btn-primary" id="btnCheckpointResume">Resume</button>
            </div>
        </div>
    </div>

    <script>
        // Attach event listeners for modal buttons (CSP-compliant)
        document.getElementById('btnIndexCancel').addEventListener('click', closeIndexModal);
        document.getElementById('btnIndexUpdate').addEventListener('click', function() { proceedWithIndex('update'); });
        document.getElementById('btnIndexReplace').addEventListener('click', function() { proceedWithIndex('replace'); });

        // Checkpoint modal listeners
        document.getElementById('btnCheckpointCancel').addEventListener('click', closeCheckpointModal);
        document.getElementById('btnCheckpointRestart').addEventListener('click', function() { proceedWithCheckpoint('restart'); });
        document.getElementById('btnCheckpointResume').addEventListener('click', function() { proceedWithCheckpoint('resume'); });
    </script>
</body>
</html>
