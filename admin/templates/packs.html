<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Source Packs - Disaster Clippy</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }

        header {
            background: #16213e;
            padding: 1rem 2rem;
            border-bottom: 1px solid #0f3460;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 1.5rem;
            color: #e94560;
        }

        header p {
            font-size: 0.9rem;
            color: #888;
            margin-top: 0.25rem;
        }

        .nav-links {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .nav-links a {
            color: #4ecca3;
            text-decoration: none;
            font-size: 0.85rem;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .nav-links a:hover {
            background: #0f3460;
        }

        .nav-links a.active {
            background: #0f3460;
            color: #e94560;
        }

        .nav-divider { width: 1px; background: #0f3460; margin: 0 0.25rem; }
        .admin-toggle { display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.75rem; background: #0f3460; border-radius: 4px; font-size: 0.8rem; color: #888; }
        .admin-toggle.active { background: #4a1942; color: #e94560; }
        .admin-toggle input { display: none; }
        .toggle-slider { width: 36px; height: 18px; background: #1a1a2e; border-radius: 9px; position: relative; cursor: pointer; transition: background 0.2s; }
        .toggle-slider::after { content: ''; position: absolute; width: 14px; height: 14px; background: #888; border-radius: 50%; top: 2px; left: 2px; transition: all 0.2s; }
        .admin-toggle.active .toggle-slider { background: #e94560; }
        .admin-toggle.active .toggle-slider::after { left: 20px; background: #fff; }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
        }

        .section {
            background: #16213e;
            border: 1px solid #0f3460;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .section h2 {
            font-size: 1.1rem;
            color: #e94560;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #0f3460;
        }

        .section p.description {
            color: #888;
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }

        .server-input {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .server-input input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #0f3460;
            border-radius: 6px;
            background: #1a1a2e;
            color: #eee;
            font-size: 0.95rem;
        }

        .server-input input:focus {
            outline: none;
            border-color: #4ecca3;
        }

        .server-input button {
            padding: 0.75rem 1rem;
            background: #4ecca3;
            color: #1a1a2e;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .server-input button:hover {
            background: #3db892;
        }

        .pack-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .pack-card {
            background: #1a1a2e;
            border: 1px solid #0f3460;
            border-radius: 8px;
            padding: 1rem;
            transition: border-color 0.2s;
        }

        .pack-card:hover {
            border-color: #4ecca3;
        }

        .pack-card.installed {
            border-color: #4ecca3;
            background: #1a2e1a;
        }

        .pack-card.complete {
            border-color: #4ecca3;
        }

        .pack-card.incomplete {
            border-color: #f9a825;
            opacity: 0.9;
        }

        .status-complete { color: #4ecca3; }
        .status-incomplete { color: #f9a825; }

        .pack-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .pack-name {
            font-size: 1rem;
            font-weight: 600;
            color: #e94560;
        }

        .pack-tier {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .tier-official {
            background: #4ecca3;
            color: #1a1a2e;
        }

        .tier-community {
            background: #f9a825;
            color: #1a1a2e;
        }

        .tier-personal {
            background: #666;
            color: #eee;
        }

        .pack-meta {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 0.5rem;
        }

        .pack-meta span {
            margin-right: 1rem;
        }

        .pack-description {
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }

        .pack-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-bottom: 0.75rem;
        }

        .tag {
            font-size: 0.7rem;
            background: #0f3460;
            color: #4ecca3;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
        }

        .pack-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: background 0.2s;
        }

        .btn-primary {
            background: #e94560;
            color: white;
        }

        .btn-primary:hover {
            background: #ff6b6b;
        }

        .btn-primary:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #0f3460;
            color: #4ecca3;
            border: 1px solid #4ecca3;
        }

        .btn-secondary:hover {
            background: #4ecca3;
            color: #1a1a2e;
        }

        .btn-installed {
            background: #2e4a2e;
            color: #4ecca3;
            cursor: default;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #888;
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: #4ecca3;
            color: #1a1a2e;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.error {
            background: #e94560;
            color: white;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-online { background: #4ecca3; }
        .status-offline { background: #e94560; }

        .license-info {
            font-size: 0.75rem;
            color: #888;
        }

        .license-verified {
            color: #4ecca3;
        }

        @media (max-width: 600px) {
            .container {
                padding: 1rem;
            }
            .pack-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div>
            <h1>Source Packs</h1>
            <p>Browse and install curated content packs</p>
        </div>
        <nav class="nav-links">
            <a href="/useradmin/dashboard">Dashboard</a>
            <a href="/useradmin/sources" class="active">Sources</a>
            <a href="/useradmin/jobs">Jobs</a>
            <a href="/useradmin/cloud">Cloud</a>
            <a href="/useradmin/settings">Settings</a>
            <a href="/useradmin/submissions">Submissions</a>
            <a href="/useradmin/pinecone">Pinecone</a>
            <a href="/">Chat</a>
            <span class="nav-divider"></span>
            <label class="admin-toggle" id="adminToggle" title="Toggle Admin Mode">
                <input type="checkbox" id="adminModeCheckbox" onchange="toggleAdminMode()">
                <span>Admin</span>
                <span class="toggle-slider"></span>
            </label>
        </nav>
    </header>

    <div class="container">
        <!-- Parent Server Connection -->
        <div class="section">
            <h2>Global Cloud Backup</h2>
            <p class="description">
                Official and community-verified source packs hosted on the global R2 cloud storage.
                These packs are curated and verified before being made available for download.
            </p>

            <div id="connectionStatus">
                <span class="status-indicator status-offline"></span>
                Checking global backup...
            </div>
        </div>

        <!-- Available Packs -->
        <div class="section">
            <h2>Available Packs</h2>
            <p class="description">Official and community-verified source packs ready for download</p>

            <div id="availablePacks" class="pack-grid">
                <div class="empty-state">Enter a parent server URL and click Connect to browse packs</div>
            </div>
        </div>

        <!-- Local Sources -->
        <div class="section">
            <h2>Local Sources</h2>
            <p class="description">All sources configured on your local system. Green = complete (ready for upload), Yellow = incomplete (missing requirements)</p>

            <div id="localSources" class="pack-grid">
                <div class="loading">Loading local sources...</div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let availablePacks = [];
        let localSources = [];

        // Load local sources with completeness status
        async function loadLocalSources() {
            try {
                const response = await fetch('/useradmin/api/local-sources');
                const data = await response.json();
                localSources = data.sources || [];
                renderLocalSources();
            } catch (e) {
                console.error('Failed to load local sources:', e);
                document.getElementById('localSources').innerHTML =
                    '<div class="empty-state">Failed to load local sources</div>';
            }
        }

        // Fetch available packs from R2 backups/ folder
        async function fetchAvailablePacks() {
            const statusEl = document.getElementById('connectionStatus');
            const packsEl = document.getElementById('availablePacks');

            statusEl.innerHTML = '<span class="status-indicator" style="background:#f9a825"></span> Connecting to Global Cloud...';
            packsEl.innerHTML = '<div class="loading">Loading available packs...</div>';

            try {
                const response = await fetch('/useradmin/api/available-packs');
                const data = await response.json();

                if (!data.connected) {
                    statusEl.innerHTML = `<span class="status-indicator status-offline"></span> ${data.error || 'Not connected'}`;
                    packsEl.innerHTML = '<div class="empty-state">Could not connect to Global Cloud Backup</div>';
                    return;
                }

                availablePacks = data.packs || [];

                statusEl.innerHTML = `<span class="status-indicator status-online"></span> Connected to Global Cloud Backup`;

                renderAvailablePacks();

            } catch (e) {
                console.error('Failed to fetch packs:', e);
                statusEl.innerHTML = '<span class="status-indicator status-offline"></span> Connection failed';
                packsEl.innerHTML = `<div class="empty-state">Error: ${e.message}</div>`;
            }
        }

        // Render available packs from cloud
        function renderAvailablePacks() {
            const container = document.getElementById('availablePacks');

            if (availablePacks.length === 0) {
                container.innerHTML = '<div class="empty-state">No packs available in Global Cloud Backup yet. Submit your sources via Cloud Upload to contribute!</div>';
                return;
            }

            container.innerHTML = availablePacks.map(pack => {
                // Check if we have this source locally
                const localSource = localSources.find(s => s.source_id === pack.source_id);
                const hasLocal = !!localSource;

                return `
                    <div class="pack-card ${hasLocal ? 'installed' : ''}">
                        <div class="pack-header">
                            <span class="pack-name">${escapeHtml(pack.name)}</span>
                            <span class="pack-tier tier-official">${pack.tier}</span>
                        </div>
                        <div class="pack-meta">
                            <span>${pack.total_size_mb.toFixed(1)} MB</span>
                            <span>${pack.files.length} file(s)</span>
                        </div>
                        <div class="pack-description">${escapeHtml(pack.description || '')}</div>
                        <div class="pack-actions">
                            ${hasLocal
                                ? `<button class="btn btn-installed" disabled>Installed</button>
                                   <button class="btn btn-secondary" onclick="redownloadPack('${pack.source_id}')">Redownload</button>`
                                : `<button class="btn btn-primary" onclick="downloadPack('${pack.source_id}')">Download</button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render local sources with completeness status
        function renderLocalSources() {
            const container = document.getElementById('localSources');

            if (localSources.length === 0) {
                container.innerHTML = '<div class="empty-state">No local sources installed. Download packs from the Cloud Packs section above.</div>';
                return;
            }

            container.innerHTML = localSources.map(source => {
                const statusClass = source.production_ready ? 'complete' : 'incomplete';

                // Determine badge based on status
                let badgeClass, badgeText;
                if (source.production_ready) {
                    badgeClass = 'tier-official';
                    badgeText = 'Ready';
                } else if (source.is_complete) {
                    badgeClass = 'tier-community';
                    badgeText = 'Complete';
                } else {
                    badgeClass = 'tier-personal';
                    badgeText = 'Incomplete';
                }

                // Determine which action buttons to show
                let actionButtons = '';
                if (source.production_ready) {
                    // Ready for upload - show upload button
                    actionButtons = `<a href="/useradmin/cloud-upload" class="btn btn-primary">Upload to Cloud</a>`;
                } else {
                    // Not ready - show edit button to fix issues
                    actionButtons = `<a href="/useradmin/source-tools?source=${source.source_id}" class="btn btn-secondary">Edit Source</a>`;
                }

                return `
                    <div class="pack-card ${statusClass}">
                        <div class="pack-header">
                            <span class="pack-name">${escapeHtml(source.name)}</span>
                            <span class="pack-tier ${badgeClass}">${badgeText}</span>
                        </div>
                        <div class="pack-meta">
                            <span>${source.document_count} docs</span>
                            <span>${source.backup_size_mb} MB</span>
                            <span>${source.backup_type || 'no backup'}</span>
                        </div>
                        <div class="pack-description">
                            <span class="check-item ${source.has_config ? 'status-complete' : 'status-incomplete'}">[${source.has_config ? 'x' : ' '}] Config</span>
                            <span class="check-item ${source.has_metadata ? 'status-complete' : 'status-incomplete'}">[${source.has_metadata ? 'x' : ' '}] Metadata</span>
                            <span class="check-item ${source.has_backup ? 'status-complete' : 'status-incomplete'}">[${source.has_backup ? 'x' : ' '}] Backup</span>
                            <span class="check-item ${source.has_embeddings ? 'status-complete' : 'status-incomplete'}">[${source.has_embeddings ? 'x' : ' '}] Embeddings</span>
                            <span class="check-item ${source.license_verified ? 'status-complete' : 'status-incomplete'}">[${source.license_verified ? 'x' : ' '}] License</span>
                        </div>
                        ${source.missing && source.missing.length > 0 ? `
                            <div style="font-size: 0.8rem; color: #f9a825; margin-top: 0.5rem;">
                                Missing: ${source.missing.join(', ')}
                            </div>
                        ` : ''}
                        ${actionButtons ? `<div class="pack-actions" style="margin-top: 0.75rem;">${actionButtons}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Generate metadata for a source
        async function generateMetadata(sourceId) {
            showToast(`Generating metadata for ${sourceId}...`, false);
            try {
                const response = await fetch('/useradmin/api/generate-metadata', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source_id: sourceId })
                });
                const data = await response.json();
                if (response.ok) {
                    showToast(`Generated metadata: ${data.document_count} documents found`, false);
                    loadLocalSources(); // Refresh
                } else {
                    showToast(data.detail || 'Failed to generate metadata', true);
                }
            } catch (e) {
                showToast('Error: ' + e.message, true);
            }
        }

        // Index a source to ChromaDB (runs as background job)
        async function indexSource(sourceId) {
            showToast(`Starting index job for ${sourceId}...`, false);
            try {
                const response = await fetch('/useradmin/api/create-index', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source_id: sourceId, limit: 1000, force_reindex: false })
                });
                const data = await response.json();
                if (response.ok) {
                    showToast(`Index job started: ${data.job_id}`, false);
                    // Refresh to show job status
                    loadLocalSources();
                } else {
                    showToast(data.detail || 'Failed to start index job', true);
                }
            } catch (e) {
                showToast('Error: ' + e.message, true);
            }
        }

        // Redownload a pack - delete local first, then download fresh
        async function redownloadPack(sourceId) {
            const btn = event.target;

            if (!confirm(`Redownload ${sourceId}?\n\nThis will delete your local copy and download fresh from the cloud. Any local changes will be lost.`)) {
                return;
            }

            const originalText = btn.textContent;
            btn.textContent = 'Deleting...';
            btn.disabled = true;

            try {
                // First delete the local source
                const deleteResponse = await fetch('/useradmin/api/delete-source', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source_id: sourceId, delete_files: true })
                });

                if (!deleteResponse.ok) {
                    const deleteData = await deleteResponse.json();
                    throw new Error(deleteData.detail || 'Failed to delete local source');
                }

                btn.textContent = 'Downloading...';

                // Now download fresh from R2
                const downloadResponse = await fetch('/useradmin/api/download-pack', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source_id: sourceId })
                });

                const downloadData = await downloadResponse.json();

                if (!downloadResponse.ok) {
                    throw new Error(downloadData.detail || 'Download failed');
                }

                showToast(downloadData.message || `Redownloaded ${sourceId} successfully!`, false);

                // Refresh both lists
                await loadLocalSources();
                renderAvailablePacks();

                btn.textContent = 'Done';

            } catch (error) {
                showToast('Redownload failed: ' + error.message, true);
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // Download a pack from R2 cloud storage
        async function downloadPack(sourceId) {
            const btn = event.target;
            const originalText = btn.textContent;

            // Check if a job is already running for this source
            if (window.jobMonitor && window.jobMonitor.hasActiveJob(sourceId)) {
                showToast('Download already in progress for this source', true);
                return;
            }

            btn.textContent = 'Starting...';
            btn.disabled = true;

            try {
                const response = await fetch('/useradmin/api/download-pack', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source_id: sourceId })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Download failed');
                }

                if (data.status === 'submitted') {
                    // Job submitted - it will run in background
                    showToast(`Download started for ${sourceId} - check progress below`);
                    btn.textContent = 'Downloading...';

                    // Trigger job monitor refresh
                    if (window.jobMonitor) {
                        window.jobMonitor.refresh();

                        // Register callback for when job completes
                        window.jobMonitor.onComplete(data.job_id, (job) => {
                            if (job.status === 'completed') {
                                btn.textContent = 'Installed';
                                btn.classList.remove('btn-primary');
                                btn.classList.add('btn-success');
                                loadLocalSources();
                                renderAvailablePacks();
                            } else {
                                btn.textContent = originalText;
                                btn.disabled = false;
                            }
                        });
                    }
                } else {
                    // Synchronous completion (fallback)
                    showToast(data.message || `Downloaded ${sourceId} successfully!`, false);
                    loadLocalSources();
                    btn.textContent = 'Installed';
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-success');
                }

            } catch (error) {
                showToast('Download failed: ' + error.message, true);
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast' + (isError ? ' error' : '');
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        loadLocalSources();
        fetchAvailablePacks();

        // Listen for job completions to refresh the UI
        window.addEventListener('jobComplete', (event) => {
            const job = event.detail;
            if (job.job_type === 'download') {
                showToast(`Download completed: ${job.source_id}`, job.status !== 'completed');
                loadLocalSources();
                renderAvailablePacks();
            }
        });

        // Hide Pinecone link if not admin
        function updatePineconeVisibility() {
            const isAdmin = localStorage.getItem('adminMode') === 'true';
            const pineconeLink = document.querySelector('a[href="/useradmin/pinecone"]');
            if (pineconeLink) {
                pineconeLink.style.display = isAdmin ? '' : 'none';
            }
        }
        updatePineconeVisibility();

        // Admin Mode Toggle
        function toggleAdminMode() {
            const checkbox = document.getElementById('adminModeCheckbox');
            const toggle = document.getElementById('adminToggle');
            const isAdmin = checkbox.checked;
            localStorage.setItem('adminMode', isAdmin ? 'true' : 'false');
            toggle.classList.toggle('active', isAdmin);
            updatePineconeVisibility();
        }
        function initAdminMode() {
            const isAdmin = localStorage.getItem('adminMode') === 'true';
            document.getElementById('adminModeCheckbox').checked = isAdmin;
            document.getElementById('adminToggle').classList.toggle('active', isAdmin);
        }
        initAdminMode();
    </script>

    <!-- Job Monitor - shows active background jobs -->
    <script src="/admin/static/job-monitor.js"></script>
</body>
</html>
